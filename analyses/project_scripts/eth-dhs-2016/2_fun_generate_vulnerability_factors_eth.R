
################################################################################
# GENERATE VULNERABILITY FACTORS
################################################################################

###################################
# RUN SETUP


###################################
# DEFINE FUNCTION
###################################

gen_vulnerability_factors_dhs_eth <- function(IR, BR, HH){

######################################################################
# 1 | WOMAN AND HER PAST EXPERIENCES
######################################################################

  # COPY IR TO CREATE SWPER SCORE TO CAPTURE WOMEN'S EMPOWERMENT
  SWPR <- copy(IR)


  # Woman's age (for adjustment / stratification)
  IR$age.yrs <- IR$v012

  ###################################
  # EDUCATION

  # Highest level of education
  IR$ed.lev <- factor(IR$v149)

  IR$anyed.yn <- ifelse(IR$v149 == "no education", 0, 1)

  IR$ed.lev.ord <- as.integer(IR$ed.lev)

  # Highest level of education of anyone in the HH (AG added)
  HH$hv108_01 <- ifelse(HH$hv108_01 == 98, 0, HH$hv108_01)
  HH$hv108_02 <- ifelse(HH$hv108_02 == 98, 0, HH$hv108_02)
  HH$hv108_03 <- ifelse(HH$hv108_03 == 98, 0, HH$hv108_03)
  HH$hv108_04 <- ifelse(HH$hv108_04 == 98, 0, HH$hv108_04)
  HH$hv108_05 <- ifelse(HH$hv108_05 == 98, 0, HH$hv108_05)
  HH$hv108_06 <- ifelse(HH$hv108_06 == 98, 0, HH$hv108_06)
  HH$hv108_07 <- ifelse(HH$hv108_07 == 98, 0, HH$hv108_07)
  HH$hv108_08 <- ifelse(HH$hv108_08 == 98, 0, HH$hv108_08)
  HH$hv108_09 <- ifelse(HH$hv108_09 == 98, 0, HH$hv108_09)
  HH$hv108_10 <- ifelse(HH$hv108_10 == 98, 0, HH$hv108_10)
  HH$hv108_11 <- ifelse(HH$hv108_11 == 98, 0, HH$hv108_11)
  HH$hv108_12 <- ifelse(HH$hv108_12 == 98, 0, HH$hv108_12)
  HH$hv108_13 <- ifelse(HH$hv108_13 == 98, 0, HH$hv108_13)
  HH$hv108_14 <- ifelse(HH$hv108_14 == 98, 0, HH$hv108_14)
  HH$hv108_15 <- ifelse(HH$hv108_15 == 98, 0, HH$hv108_15)
  HH$hv108_16 <- ifelse(HH$hv108_16 == 98, 0, HH$hv108_16)
  HH$hv108_17 <- ifelse(HH$hv108_17 == 98, 0, HH$hv108_17)
  HH$hv108_18 <- ifelse(HH$hv108_18 == 98, 0, HH$hv108_18)
  HH$hv108_19 <- ifelse(HH$hv108_19 == 98, 0, HH$hv108_19)
  HH$hv108_20 <- ifelse(HH$hv108_20 == 98, 0, HH$hv108_20)

  HH$highestyearsedinHH.yrs <- pmax(HH$hv108_01, HH$hv108_02, HH$hv108_03, HH$hv108_04, HH$hv108_05, HH$hv108_06, HH$hv108_07, HH$hv108_08, HH$hv108_09, HH$hv108_10, HH$hv108_11, HH$hv108_12, HH$hv108_13, HH$hv108_14, HH$hv108_15, HH$hv108_16, HH$hv108_17, HH$hv108_18, HH$hv108_19, HH$hv108_20, na.rm= TRUE)

  HH$highestyearsedinHH.7plus <- ifelse(HH$highestyearsedinHH.yrs >= 7, '7+', '0-7')

  ###################################
  # PARTNERSHIP

  # Partnership status
  IR$pship.status <- factor(IR$v501)
  IR$marr.cohab<-ifelse(IR$v501 == "married" | IR$v501 == "living with partner",1,0) # ==> consider revising cutoff or making another variable for ever partnered?

  #Partnership by category AG 2/21/23
  IR$pship.cat <- IR$pship.status
  IR<- IR %>% mutate(pship.cat = case_when
                     (
                       pship.status == "never in union" ~ "never",
                       pship.status == "widowed" ~ "no partner now",
                       pship.status == "divorced" ~ "no partner now",
                       pship.status == "no longer living together/separated" ~ "no partner now",
                       pship.status == "married" ~ "married/cohab",
                       pship.status == "living with partner" ~ "married/cohab"
                     )
  )

  ###################################
  # Age at first marriage/cohabitation
  IR$age.1stcohab <- IR$v511

  IR<- IR %>% mutate(age.1stcohab.cat = case_when(
    v501 == "never in union" ~ "never",
    (v511 > 0 & v511 < 15) ~ "5-14",
    (v511 >= 15 & v511 < 20) ~ "15-19",
    (v511 >= 20) ~ "20+"))

  IR$early.cohab.15 <- ifelse(IR$age.1stcohab.cat == "5-14", 1, 0)


  ###################################
  # Age at first sex
  IR$age.1stsex <- ifelse(IR$v531 == 97,NA,
                          ifelse(IR$v531 == 98, NA,
                                 ifelse(IR$v531 == 0, NA, IR$v531)))

  IR<- IR %>% mutate(age.1stsex.cat = case_when(
    v531 == 0 ~ "never",
    (age.1stsex > 0 & age.1stsex < 15) ~ "5-14",
    (age.1stsex >= 15 & age.1stsex < 20) ~ "15-19",
    (age.1stsex >= 20 & age.1stsex < 50) ~ "20+",
    v531 %in% c(97, 98) ~ "Inconsistent or don't know"))

  IR$early.sex.15 <- ifelse(IR$v531 >0 & IR$v531 <15, 1, 0)


  ###################################
  # Time from marriage to fist birth
  IR$months.cohabbirth <- IR$v221
  IR$months.cohabbirth[IR$v221 == 996] <- NA

  IR<- IR %>% mutate(months.cohabbirth.cat = case_when(
    v221 == 996 ~ "Before marriage", #
    (v221 >= 0 & v221 < 10) ~ "0-9 months",
    (v221 >= 10 & v221 < 25) ~ "10-24 months",
    (v221 >= 25 & v221 < 61) ~ "25-60 months",
    (v221 >= 61 & v221 < 400) ~ ">61 months",
    v501 == "never in union" ~ "never in union",
    v201 == 0 ~ "never given birth"))


  ###################################
  # Age at first birth
  IR$age.1stbrth <- IR$v212
  IR <- IR %>% mutate(age.1stbrth.cat = case_when(
    is.na(v212) ~ "no births",
    (v212 > 0 & v212 < 15) ~ "5-14",
    (v212 >= 15 & v212 < 20) ~ "15-19",
    (v212 >= 20 & v212 < 50) ~ "20+"))

  IR$early.birth.15 <- ifelse(IR$age.1stbrth.cat =="5-14", 1, 0)


  ###################################
  # Number of pregnancies
  IR$num.preg <- IR$v201
  IR$num.preg <- ifelse(IR$v228 == "yes" & IR$v234 == "yes", IR$v201 + 2,
                        ifelse(IR$v228 == "yes" & IR$v234 == "no", IR$v201 + 1,
                               IR$v201))

  IR$preg.4plus <- ifelse(IR$num.preg >=4 & !is.na(IR$num.preg), 1, 0)


  ###################################
  # Number of children living
  IR$num.children <- IR$v218
  IR$child.4plus <- ifelse(IR$v218 >=4 & !is.na(IR$v218), 1, 0)


  ###################################
  # Attitudes about domestic violence
  IR <- IR %>% mutate(dv.out = case_when(
    v744a =="no" ~0,
    v744a == "yes" ~1))

  IR <- IR %>% mutate(dv.negkid = case_when(
    v744b =="no" ~0,
    v744b == "yes" ~1))

  IR <- IR %>% mutate(dv.argue = case_when(
    v744c =="no" ~0,
    v744c == "yes" ~1))

  IR <- IR %>% mutate(dv.nosex = case_when(
    v744d =="no" ~0,
    v744d == "yes" ~1))

  IR <- IR %>% mutate(dv.burnfd = case_when(
    v744e =="no" ~0,
    v744e == "yes" ~1))

  IR$dv.nacnt <- IR  %>%
    rowwise() %>%
    summarise(dv.nacnt = sum(is.na(dv.out),is.na(dv.negkid),is.na(dv.argue),is.na(dv.nosex),is.na(dv.burnfd)))

  IR<-IR %>%
    rowwise() %>%
    mutate(dv.sum = sum(dv.out, dv.negkid, dv.argue, dv.nosex, dv.burnfd, na.rm=TRUE))

  IR$dv.index <-ifelse(IR$dv.nacnt == 5, NA, IR$dv.sum)
  IR$dv.index <-as.numeric(IR$dv.index)

  IR$dv.index.yn <- ifelse(IR$dv.index %in% c(4, 5), 1,
                           ifelse(IR$dv.index %in% c(0:3), 0, NA))


  ###################################
  # Male child preference
  IR <- IR %>%
    mutate(v627=as.numeric(v627),
           v628=as.numeric(v628))

  IR$child.pref.discrep <- ifelse(IR$v627 %in% c(0:30) & IR$v628 %in% c(0:30), IR$v627-IR$v628,
                                  NA)
  IR$male.child.pref <- ifelse(IR$child.pref.discrep > 0 & !is.na(IR$child.pref.discrep), 1,
                               ifelse(IR$child.pref.discrep <=0 & !is.na(IR$child.pref.discrep), 0,
                                      ifelse(IR$v627 %in% c(95:98) & IR$v628 %in% c(95:98), 0,
                                             NA)))


  ###################################
  # Religion
  IR$religion <- IR$v130
  IR$muslim<-ifelse(IR$v130 == "muslin",1,0) #note misspelling in DHS

  #re-categorizing traditional, other and protestant together given extremely small sample sizes
  IR$religionrecode.cat <- IR$religion
  IR<- IR %>% mutate(religionrecode.cat =case_when(
    (religion=="traditional") ~ "other",
    (religion=="catholic") ~ "other",
    (religion=="other") ~ "other",
    (religion=="protestant") ~ "protestant",
    (religion=="orthodox") ~ "orthodox",
    (religion=="muslin") ~ "muslim"))

  IR$orthodox <- ifelse(IR$v130 =="orthodox", 1, 0)


  ###################################
  # MEDIA EXPOSURE
  IR<-IR %>% mutate(freq.newsp = case_when(
    (v157== "not at all" | is.na(v157)) ~ 0,
    v157=="at least once a week" ~2,
    v157=="less than once a week" ~1))
  IR$freq.newsp <- factor(IR$freq.newsp)

  IR$newsp.yn<-ifelse((IR$v157== "not at all" | is.na(IR$v157)),0,1)

  IR<-IR %>% mutate(freq.rad = case_when(
    (v158== "not at all" | is.na(v158)) ~ 0,
    v158=="at least once a week" ~2,
    v158=="less than once a week" ~1))
  IR$freq.rad <- factor(IR$freq.rad)

  IR$rad.yn<-ifelse((IR$v158== "not at all" | is.na(IR$v158)),0,1)

  IR<-IR %>% mutate(freq.tv = case_when(
    (v159=="not at all" | is.na(v159)) ~ 0,
    v159 == "at least once a week" ~2,
    v159 == "less than once a week" ~1))
  IR$freq.tv <- factor(IR$freq.tv)

  IR$tv.yn<-ifelse((IR$v159=="not at all" | is.na(IR$v159)),0,1)

  IR$any.media.yn <- ifelse((IR$newsp.yn == 1 | IR$rad.yn == 1 | IR$tv.yn == 1), 1, 0)


  ######################################################################
  # 2 | HOUSEHOLD RELATIONSHIPS
  ######################################################################

  ###################################
  # Type of marriage, among married women
  IR$polygamy <- ifelse(IR$v505 %in% c(1:20), 1, 0) # Currently coded those who don't know and those not currently partnered as 0


  ###################################
  # Wife order, among women in polygamous union
  IR$wife.order <- IR$v506
  IR$wife.order[IR$v506 == 98] <- NA

  IR <- IR %>% mutate(first.wife = case_when(
    v506 == 1 ~ "First wife",
    v506 %in% c(2:20) ~ "Second or more wife",
    v506 == 98 ~ "Not known",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union",
    v505 == 0 ~ "Monomgaous union"))


  ###################################
  # Number of adults (15+) in the household
  # First impute unknown ages to the mean
  HH$age_01 <- ifelse(HH$hv105_01 == 98, mean(HH$hv105_01, na.rm=TRUE), HH$hv105_01)
  HH$age_02 <- ifelse(HH$hv105_02 == 98, mean(HH$hv105_02, na.rm=TRUE), HH$hv105_02)
  HH$age_03 <- ifelse(HH$hv105_03 == 98, mean(HH$hv105_03, na.rm=TRUE), HH$hv105_03)
  HH$age_04 <- ifelse(HH$hv105_04 == 98, mean(HH$hv105_04, na.rm=TRUE), HH$hv105_04)
  HH$age_05 <- ifelse(HH$hv105_05 == 98, mean(HH$hv105_05, na.rm=TRUE), HH$hv105_05)
  HH$age_06 <- ifelse(HH$hv105_06 == 98, mean(HH$hv105_06, na.rm=TRUE), HH$hv105_06)
  HH$age_07 <- ifelse(HH$hv105_07 == 98, mean(HH$hv105_07, na.rm=TRUE), HH$hv105_07)
  HH$age_08 <- ifelse(HH$hv105_08 == 98, mean(HH$hv105_08, na.rm=TRUE), HH$hv105_08)
  HH$age_09 <- ifelse(HH$hv105_09 == 98, mean(HH$hv105_09, na.rm=TRUE), HH$hv105_09)
  HH$age_10 <- ifelse(HH$hv105_10 == 98, mean(HH$hv105_10, na.rm=TRUE), HH$hv105_10)
  HH$age_11 <- ifelse(HH$hv105_11 == 98, mean(HH$hv105_11, na.rm=TRUE), HH$hv105_11)
  HH$age_12 <- ifelse(HH$hv105_12 == 98, mean(HH$hv105_12, na.rm=TRUE), HH$hv105_12)
  HH$age_13 <- ifelse(HH$hv105_13 == 98, mean(HH$hv105_13, na.rm=TRUE), HH$hv105_13)
  HH$age_14 <- ifelse(HH$hv105_14 == 98, mean(HH$hv105_14, na.rm=TRUE), HH$hv105_14)
  HH$age_15 <- ifelse(HH$hv105_15 == 98, mean(HH$hv105_15, na.rm=TRUE), HH$hv105_15)
  HH$age_16 <- ifelse(HH$hv105_16 == 98, mean(HH$hv105_16, na.rm=TRUE), HH$hv105_16)
  HH$age_17 <- ifelse(HH$hv105_17 == 98, mean(HH$hv105_17, na.rm=TRUE), HH$hv105_17)
  HH$age_18 <- ifelse(HH$hv105_18 == 98, mean(HH$hv105_18, na.rm=TRUE), HH$hv105_18)
  HH$age_19 <- ifelse(HH$hv105_19 == 98, mean(HH$hv105_19, na.rm=TRUE), HH$hv105_19)
  HH$age_20 <- ifelse(HH$hv105_20 == 98, mean(HH$hv105_20, na.rm=TRUE), HH$hv105_20)

  # Categorize each member as 15+ or younger
  HH$age15up_01 <- ifelse(HH$age_01 >= 15, 1, 0)
  HH$age15up_02 <- ifelse(HH$age_02 >= 15, 1, 0)
  HH$age15up_03 <- ifelse(HH$age_03 >= 15, 1, 0)
  HH$age15up_04 <- ifelse(HH$age_04 >= 15, 1, 0)
  HH$age15up_05 <- ifelse(HH$age_05 >= 15, 1, 0)
  HH$age15up_06 <- ifelse(HH$age_06 >= 15, 1, 0)
  HH$age15up_07 <- ifelse(HH$age_07 >= 15, 1, 0)
  HH$age15up_08 <- ifelse(HH$age_08 >= 15, 1, 0)
  HH$age15up_09 <- ifelse(HH$age_09 >= 15, 1, 0)
  HH$age15up_10 <- ifelse(HH$age_10 >= 15, 1, 0)
  HH$age15up_11 <- ifelse(HH$age_11 >= 15, 1, 0)
  HH$age15up_12 <- ifelse(HH$age_12 >= 15, 1, 0)
  HH$age15up_13 <- ifelse(HH$age_13 >= 15, 1, 0)
  HH$age15up_14 <- ifelse(HH$age_14 >= 15, 1, 0)
  HH$age15up_15 <- ifelse(HH$age_15 >= 15, 1, 0)
  HH$age15up_16 <- ifelse(HH$age_16 >= 15, 1, 0)
  HH$age15up_17 <- ifelse(HH$age_17 >= 15, 1, 0)
  HH$age15up_18 <- ifelse(HH$age_18 >= 15, 1, 0)
  HH$age15up_19 <- ifelse(HH$age_19 >= 15, 1, 0)
  HH$age15up_20 <- ifelse(HH$age_20 >= 15, 1, 0)

  # Sum the number 15+
  HH <- HH %>% rowwise() %>%
    mutate(num.15up = sum(age15up_01, age15up_02, age15up_03, age15up_04, age15up_05, age15up_06,
                          age15up_07, age15up_08, age15up_09, age15up_10, age15up_11, age15up_12,
                          age15up_13, age15up_14, age15up_15, age15up_16, age15up_17, age15up_18,
                          age15up_19, age15up_20, na.rm=TRUE))

  HH <- HH %>% mutate(num.15up.cat = case_when(
    num.15up %in% c(0, 1) ~ "0 to 1",
    num.15up %in% c(2) ~ "2",
    num.15up %in% c(3:4) ~ "3-4",
    num.15up >=5 ~ "5 and up"))

  # Recode num.15up as binary
  HH$num.15up.4plus<-ifelse(HH$num.15up>=4,1,0)


  ###################################
  # Partner does not live in the household (among women married or in union)
  IR <- IR %>% mutate(partner.absent = case_when(
    v504 == "living with her" ~ "No",
    v504 == "staying elsewhere" ~ "Yes",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))

  IR$partner.absent.yn <- ifelse(IR$partner.absent == "Yes", 1, 0)


  ###################################
  # Sex of head of household
  IR$head.sex <- IR$v151
  IR$head.sex.male.num <- ifelse(IR$head.sex == "male", 1, 0)


  ###################################
  # Duration of marriage, among women still with first partner
  IR$yrs.curr.pship <- ifelse(IR$v503 == "once" & IR$v501 %in% c("married", "living with partner"), IR$v512, NA)

  IR <- IR %>% mutate(pship.duration = case_when(
    v501 %in% c("never in union") ~ "Never in union",
    (v501 %in% c("widowed", "divorced", "no longer living together/separated") | v503 %in% c("more than once")) ~ "No longer with first partner",
    yrs.curr.pship %in% c(0:4) ~ "Less than 5 years",
    yrs.curr.pship %in% c(5:39) ~ "More than 5 years"))
  IR$pship.duration <- factor(IR$pship.duration, levels = c("Never in union", "Less than 5 years", "More than 5 years", "No longer with first partner"))


  ###################################
  # Number of children in the household
  # Under 5
  IR$num.under5 <- IR$v137
  IR <- IR %>% mutate(num.under5.cat = case_when(
    v137 == 0 ~ "0",
    v137 == 1 ~ "1",
    v137 ==2 ~ "2",
    (v137 >=3 & !is.na(v137)) ~ "3+"))

  IR$num.under5.2plus <- ifelse(IR$v137 >=2 & !is.na(IR$v137), 1, 0)

  # Under 15
  HH$age.under15_01 <- ifelse(HH$age_01 < 15, 1, 0)
  HH$age.under15_02 <- ifelse(HH$age_02 < 15, 1, 0)
  HH$age.under15_03 <- ifelse(HH$age_03 < 15, 1, 0)
  HH$age.under15_04 <- ifelse(HH$age_04 < 15, 1, 0)
  HH$age.under15_05 <- ifelse(HH$age_05 < 15, 1, 0)
  HH$age.under15_06 <- ifelse(HH$age_06 < 15, 1, 0)
  HH$age.under15_07 <- ifelse(HH$age_07 < 15, 1, 0)
  HH$age.under15_08 <- ifelse(HH$age_08 < 15, 1, 0)
  HH$age.under15_09 <- ifelse(HH$age_09 < 15, 1, 0)
  HH$age.under15_10 <- ifelse(HH$age_10 < 15, 1, 0)
  HH$age.under15_11 <- ifelse(HH$age_11 < 15, 1, 0)
  HH$age.under15_12 <- ifelse(HH$age_12 < 15, 1, 0)
  HH$age.under15_13 <- ifelse(HH$age_13 < 15, 1, 0)
  HH$age.under15_14 <- ifelse(HH$age_14 < 15, 1, 0)
  HH$age.under15_15 <- ifelse(HH$age_15 < 15, 1, 0)
  HH$age.under15_16 <- ifelse(HH$age_16 < 15, 1, 0)
  HH$age.under15_17 <- ifelse(HH$age_17 < 15, 1, 0)
  HH$age.under15_18 <- ifelse(HH$age_18 < 15, 1, 0)
  HH$age.under15_19 <- ifelse(HH$age_19 < 15, 1, 0)
  HH$age.under15_20 <- ifelse(HH$age_20 < 15, 1, 0)

  # Sum the number <15
  HH <- HH %>% rowwise() %>%
    mutate(num.under15 = sum(age.under15_01, age.under15_02, age.under15_03, age.under15_04, age.under15_05, age.under15_06,
                             age.under15_07, age.under15_08, age.under15_09, age.under15_10, age.under15_11, age.under15_12,
                             age.under15_13, age.under15_14, age.under15_15, age.under15_16, age.under15_17, age.under15_18,
                             age.under15_19, age.under15_20, na.rm=TRUE))

  HH <- HH %>% mutate(num.under15.cat = case_when(
    num.under15 %in% c(0) ~ "0",
    num.under15 %in% c(1) ~ "1",
    num.under15 %in% c(2) ~ "2",
    num.under15 %in% c(3) ~ "3",
    num.under15 %in% c(4) ~ "4",
    num.under15 >=5 ~ "5 and up"))

  # Binary indicator of num.under15
  HH$num.under15.3plus <- ifelse(HH$num.under15 >= 3, 1, 0)

  # Ratio of kids under 5 to women 15-49
  HH$hh.kidwom.rat<-ifelse(HH$hv010 == 0, 0, (HH$hv014/HH$hv010))

  HH$hh.kidwom.rat.cat<-ifelse(HH$hh.kidwom.rat==0,0,
                               ifelse(HH$hh.kidwom.rat>0 & HH$hh.kidwom.rat<1,1,
                                      ifelse(HH$hh.kidwom.rat>=1 & HH$hh.kidwom.rat<2,2,
                                             ifelse(HH$hh.kidwom.rat>=2 & HH$hh.kidwom.rat<3,3,4))))

  HH$hh.kidwom.rat.2plus<-ifelse(HH$hh.kidwom.rat>=2,1,0)


  ###################################
  # Number of children living
  IR$num.child.alive <- IR$v218
  IR <- IR %>% mutate(num.child.alive.cat = case_when(
    v218 %in% c(0) ~ "0",
    v218 %in% c(1:2) ~ "1-2",
    v218 %in% c(3:5) ~ "3-5",
    (v218 >=6 & !is.na(v218)) ~ "6+"))


  ###################################
  # Ages of living children
  # Number under 5
  BR <- BR %>% group_by(caseid) %>%
    mutate(kids.under5 = sum(b8 <5, na.rm = TRUE))

  BR <- BR %>% mutate(kids.under5.cat = case_when(
    kids.under5 == 0 ~ "0",
    kids.under5 == 1 ~ "1",
    kids.under5 ==2 ~ "2",
    (kids.under5 >=3 & !is.na(kids.under5)) ~ "3+"))

  # number under 15
  BR <- BR %>% group_by(caseid) %>%
    mutate(kids.under15 = sum(b8 <15, na.rm = TRUE))

  BR <- BR %>% mutate(kids.under15.cat = case_when(
    kids.under15 %in% c(0) ~ "0",
    kids.under15 %in% c(1) ~ "1",
    kids.under15 %in% c(2) ~ "2",
    kids.under15 %in% c(3) ~ "3",
    kids.under15 %in% c(4) ~ "4",
    kids.under15 >=5 ~ "5 and up"))


  ###################################
  # CHILDREN THAT HAVE DIED
  IR$num.child.die <- IR$v206 + IR$v207
  IR <- IR %>% mutate(num.child.die.cat = case_when(
    num.child.die %in% c(0) ~ "0",
    num.child.die %in% c(1) ~ "1",
    num.child.die >=2 ~ "2 or more"))


  ###################################
  # Number of biological children in the household
  IR <- IR %>%
    rowwise() %>%
    mutate(num.kids.house = sum(v202, v203, na.rm=TRUE))

  IR <- IR %>% mutate(num.kids.house.cat = case_when(
    num.kids.house %in% c(0) ~ "0",
    num.kids.house %in% c(1) ~ "1",
    num.kids.house %in% c(2,3) ~ "2-3",
    num.kids.house >=4 ~ "4 or more"))

  IR$num.kids.house.4plus <- ifelse(IR$num.kids.house.cat=="4 or more",1,0)


  ###################################
  # Number of children <15 living elsewhere
  BR$lives.away <- ifelse((BR$b9 %in% c("lives elsewhere", "someone else", "other relative", "father") & BR$b8 <15), 1, 0)

  BR <- BR %>%
    group_by(caseid) %>%
    mutate(num.kids.away = sum(lives.away, na.rm = TRUE))

  BR <- BR %>% mutate(num.kids.away.cat = case_when(
    num.kids.away %in% c(0) ~ "0",
    num.kids.away %in% c(1) ~ "1",
    num.kids.away %in% c(2) ~ "2",
    num.kids.away >=3 ~ "3 or more"))


  ###################################
  # Domestic violence - physical
  IR <- IR %>% mutate(dv.physical = case_when(
    (d106 == "no" & d107 == "no") ~ "None",
    (d106 == "yes" & d107 == "no") ~ "Less severe",
    (d107 == "yes") ~ "Severe",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))


  ###################################
  # Domestic violence - emotional
  IR <- IR %>% mutate(dv.emotional = case_when(
    d104 == "yes" ~ "Yes",
    d104 == "no" ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))


  ###################################
  # Domestic violence - sexual
  IR <- IR %>% mutate(dv.sexual = case_when(
    d108 == "yes" ~ "Yes",
    d108 == "no" ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))


  ###################################
  # Violence from other household/community members
  IR$violence_other <- 0
  IR$violence_other[(IR$d115b == "yes" | IR$d115c == "yes" | IR$d115d == "yes" |
                       IR$d115e == "yes" | IR$d115f == "yes" | IR$d115g == "yes" |
                       IR$d115h == "yes" | IR$d115i == "yes" | IR$d115j == "yes" |
                       IR$d115k == "yes" | IR$d115l == "yes" | IR$d115m == "yes" |
                       IR$d115n == "yes" | IR$d115o == "yes" | IR$d115p == "yes" |
                       IR$d115q == "yes" | IR$d115r == "yes" | IR$d115s == "yes" |
                       IR$d115t == "yes" | IR$d115u == "yes" | IR$d115v == "yes" |
                       IR$d115w == "yes" | IR$d115x == "yes")] <- 1
  IR$violence_other[(is.na(IR$d115b) & is.na(IR$d115c) & is.na(IR$d115d) &
                       is.na(IR$d115e) & is.na(IR$d115f) & is.na(IR$d115g) &
                       is.na(IR$d115h) & is.na(IR$d115i) & is.na(IR$d115j) &
                       is.na(IR$d115k) & is.na(IR$d115l) & is.na(IR$d115m) &
                       is.na(IR$d115n) & is.na(IR$d115o) & is.na(IR$d115p) &
                       is.na(IR$d115q) & is.na(IR$d115r) & is.na(IR$d115s) &
                       is.na(IR$d115t) & is.na(IR$d115u) & is.na(IR$d115v) &
                       is.na(IR$d115w) & is.na(IR$d115x))] <- NA


  ###################################
  # Partner's age
  IR$partner.age <- IR$v730
  IR <- IR %>% mutate(partner.age.cat = case_when(
    v730 %in% c(15:19) ~ "15-19",
    v730 %in% c(20:24) ~ "20-24",
    v730 %in% c(25:29) ~ "25-29",
    v730 %in% c(30:34) ~ "30-34",
    v730 %in% c(35:39) ~ "35-39",
    v730 %in% c(40:44) ~ "40-44",
    v730 %in% c(45:49) ~ "45-49",
    v730 %in% c(50:54) ~ "50-54",
    v730 %in% c(55:59) ~ "55-59",
    v730 %in% c(60:64) ~ "60-64",
    v730 %in% c(65:69) ~ "65-69",
    v730 %in% c(70:96) ~ "70+",
    v730 == 98 ~ "Don't know",
    v730 == 99 ~ "Missing",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))


  ###################################
  # Difference between woman's and partner's age
  IR$age.diff <- IR$v730 - IR$v012
  IR$age.diff[is.na(IR$v730) | IR$v730 > 96] <- NA

  IR <- IR %>% mutate(age.diff.cat = case_when(
    age.diff < (-2) ~ "Partner 2 or more years younger",
    age.diff %in% c(-1:1) ~ "Partner within 1 year",
    age.diff %in% c(2:5) ~ "Partner 2-5 years older",
    age.diff %in% c(6:10) ~ "Partner 6-10 years older",
    age.diff >10 & !is.na(age.diff) ~ "Partner more than 10 years older",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))
  IR$age.diff.cat <- factor(IR$age.diff.cat, levels = c("Partner 2 or more years younger",
                                                        "Partner within 1 year", "Partner 2-5 years older", "Partner 6-10 years older", "Partner more than 10 years older",
                                                        "Not in union"))


  ###################################
  # Husband's education
  IR$husb.ed.grp <- as.character(IR$v729)
  IR$no.partner <- ifelse((IR$v502== "never in union" | IR$v502=="formerly in union/living with a man"), 1, 0)
  IR$husb.ed.grp <- ifelse(IR$no.partner == 1,"Not in union",IR$husb.ed.grp)
  IR$husb.ed.grp <- factor(IR$husb.ed.grp, levels = c("Not in union", "no education", "incomplete primary",
                                                      "complete primary", "incomplete secondary", "complete secondary",
                                                      "higher", "don't know"))

  IR$husb.ed.mtprim <- ifelse(IR$husb.ed.grp %in% c("incomplete secondary", "complete secondary", "higher"), 1, 0)


  ###################################
  # Woman had previous partnerships
  IR <- IR %>% mutate(prev.pship = case_when(
    v503 %in% c("once") ~ "No",
    v503 %in% c("more than once") ~ "Yes",
    v501 %in% c("never in union") ~ "Never in union"))


  ###################################
  # Partner helps with chores
  if (all(c('s924a', 's924b') %in% names(IR))){
    IR <- IR %>% mutate(partner.chores = case_when(
      s924a == "no" ~ "No",
      (s924a == "yes" & s924b == "almost every day") ~ "Almost every day",
      (s924a == "yes" & s924b == "at least once a week") ~ "At least once a week",
      (s924a == "yes" & s924b == "rarely") ~ "Rarely",
      s924a == "not living husband/partner" ~ "Not living with husband/partner",
      !(v501 %in% c("married", "living with partner")) ~ "Not in union"))

    IR$part.nochores <- ifelse(IR$partner.chores == "No", 1, 0)
  } else {print("s924a & s924b do not exist in HH")}


  ######################################################################
  # 3 | DECISIONMAKING
  ######################################################################


  ###################################
  # Financial decision-making
  #Joint decision
  IR$jd.ownincome <- ifelse(IR$v739== "respondent and husband/partner",1,0)
  IR <- IR %>% mutate(jd.ownincome.cat = case_when(
    v739 == "respondent and husband/partner" ~ "Yes",
    (!is.na(v739) & !(v739 == "respondent and husband/partner")) ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union",
    (v501 %in% c("married", "living with partner") & (v741 %in% c("not paid", "in-kind only") | v731 == "no")) ~ "Not paid in cash or not working"))


  ###################################
  # Own decision
  IR$wd.ownincome <- ifelse(IR$v739== "respondent alone",1,0)
  IR <- IR %>% mutate(wd.ownincome.cat = case_when(
    v739 == "respondent alone" ~ "Yes",
    (!is.na(v739) & !(v739 == "respondent alone")) ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union",
    (v501 %in% c("married", "living with partner") & (v741 %in% c("not paid", "in-kind only") | v731 == "no")) ~ "Not paid in cash or not working"))

  # Joint or own decision
  IR$jdwd.ownincome <- ifelse(IR$v739== "respondent alone" | IR$v739=="respondent and husband/partner",1,0)


  ###################################
  # Large household purchases
  # Joint decision
  IR$jd.lrgpur <- ifelse(IR$v743b== "respondent and husband/partner",1,0)
  IR <- IR %>% mutate(jd.lrgpur.cat = case_when(
    v743b == "respondent and husband/partner" ~ "Yes",
    (!is.na(v743b) & !(v743b == "respondent and husband/partner")) ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))


  ###################################
  # Own decision
  IR$wd.lrgpur <- ifelse(IR$v743b== "respondent alone",1,0)
  IR <- IR %>% mutate(wd.lrgpur.cat = case_when(
    v743b == "respondent alone" ~ "Yes",
    (!is.na(v743b) & !(v743b == "respondent alone")) ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))

  #Joint or own decision
  IR$jdwd.lrgpur <- ifelse(IR$v743b== "respondent alone" | IR$v743b=="respondent and husband/partner",1,0)


  ###################################
  # Husband's income
  # Joint decision
  IR$jd.money <- ifelse(IR$v743d== "respondent and husband/partner",1,0)
  IR <- IR %>% mutate(jd.money.cat = case_when(
    v743d == "respondent and husband/partner" ~ "Yes",
    (!is.na(v743d) & !(v743d == "respondent and husband/partner")) ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))


  ###################################
  # Own decision
  IR$wd.money <- ifelse(IR$v743f== "respondent alone",1,0)
  IR <- IR %>% mutate(wd.money.cat = case_when(
    v743f == "respondent alone" ~ "Yes",
    (!is.na(v743f) & !(v743f == "respondent alone")) ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))

  #Joint or own decision
  IR$jdwd.money <- ifelse(IR$v743f== "respondent alone" | IR$v743f=="respondent and husband/partner",1,0)


  ###################################
  # Health decision-making
  # Joint decision
  IR$jd.hlth <- ifelse(IR$v743a== "respondent and husband/partner",1,0)
  IR <- IR %>% mutate(jd.hlth.cat = case_when(
    v743a == "respondent and husband/partner" ~ "Yes",
    (!is.na(v743a) & !(v743a == "respondent and husband/partner")) ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))


  ###################################
  # Own decision
  IR$wd.hlth <- ifelse(IR$v743a== "respondent alone",1,0)
  IR <- IR %>% mutate(wd.hlth.cat = case_when(
    v743a == "respondent alone" ~ "Yes",
    (!is.na(v743a) & !(v743a == "respondent alone")) ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))

  #Joint or own decision
  IR$jdwd.hlth <- ifelse(IR$v743a== "respondent alone" | IR$v743a=="respondent and husband/partner",1,0)


  ###################################
  # Decisions about family planning (use is v632 or non-use is v632a)
  # Joint decision
  IR <- IR %>% mutate(jd.fp = case_when(
    (v632 %in% c("joint decision") | v632a %in% c("joint decision")) ~ "Yes",
    ((!is.na(v632) & !(v632 == "joint decision")) | (!is.na(v632a) & !(v632a == "joint decision"))) ~ "No"))
  IR$jd.fp <- ifelse(IR$jd.fp=='Yes',1,0)

  IR <- IR %>% mutate(jd.fp.cat = case_when(
    (v632 %in% c("joint decision") | v632a %in% c("joint decision")) ~ "Yes",
    ((!is.na(v632) & !(v632 == "joint decision")) | (!is.na(v632a) & !(v632a == "joint decision"))) ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union",
    v213 == 1 ~ "Pregnant"))

  # Own decision
  IR <- IR %>% mutate(wd.fp = case_when(
    (v632 %in% c("mainly respondent") | v632a %in% c("mainly respondent")) ~ "Yes",((!is.na(v632) & !(v632 == "mainly respondent")) | (!is.na(v632a) & !(v632a == "mainly respondent"))) ~ "No"))
  IR$wd.fp <- ifelse(IR$wd.fp=="Yes",1,0)

  IR <- IR %>% mutate(wd.fp.cat = case_when(
    (v632 %in% c("mainly respondent") | v632a %in% c("mainly respondent")) ~ "Yes",
    ((!is.na(v632) & !(v632 == "mainly respondent")) | (!is.na(v632a) & !(v632a == "mainly respondent"))) ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union",
    v213 == 1 ~ "Pregnant"))

  # Joint or own decision
  IR <- IR %>% mutate(jdwd.fp = case_when(
    v632 %in% c("joint decision") | v632a %in% c("joint decision") | v632 %in% c("mainly respondent") | v632a %in% c("mainly respondent") ~ "Yes",
    v632 %in% c("mainly husband, partner") | v632 %in% c("other") ~ "No",
    v632a %in% c("mainly husband, partner") | v632a %in% c("other") ~ "No"))
  IR$jdwd.fp <- ifelse(IR$jdwd.fp=='Yes',1,0)


  ###################################
  # Everyday decisions
  # Joint decision
  IR$jd.visit <- ifelse(IR$v743d== "respondent and husband/partner",1,0)
  IR <- IR %>% mutate(jd.visit.cat = case_when(
    v743d == "respondent and husband/partner" ~ "Yes",
    (!is.na(v743d) & !(v743d == "respondent and husband/partner")) ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))

  # Own decision
  IR$wd.visit <- ifelse(IR$v743d== "respondent alone",1,0)
  IR <- IR %>% mutate(wd.visit.cat = case_when(
    v743d == "respondent alone" ~ "Yes",
    (!is.na(v743d) & !(v743d == "respondent alone")) ~ "No",
    !(v501 %in% c("married", "living with partner")) ~ "Not in union"))

  #Joint or own decision
  IR$jdwd.visit <- ifelse(IR$v743d== "respondent alone" | IR$v743d=="respondent and husband/partner",1,0)


  ###################################
  # Index of  decision-making
  IR$jd.nacnt <- IR %>%
    rowwise() %>%
    summarise(jd.nacnt = sum(is.na(jd.hlth), is.na(jd.fp), is.na(jd.lrgpur),is.na(jd.visit),is.na(jd.money), is.na(jd.ownincome)))

  IR <- IR %>%
    rowwise() %>%
    mutate(jd.sum = sum(jd.hlth, jd.fp, jd.lrgpur, jd.visit, jd.money, jd.ownincome, na.rm=TRUE))

  IR$jd.index<-ifelse(IR$jd.nacnt == 6, NA, IR$jd.sum)
  IR$jd.index<-as.numeric(IR$jd.index)

  # binary version, 0 = less joint decision making. So larger here in theory means less vulnerable
  IR$jd.index.5plus<-ifelse(IR$jd.index>=5,1,0)
  IR$jd.index.5plus[IR$marr.cohab==0] <- 0


  ###################################
  # Categorical
  IR <- IR %>% mutate(jd.index.cat = case_when(
    marr.cohab == 0 ~ "Not partnered",
    jd.index == 0 ~ "None",
    jd.index %in% c(1:4) ~ "One to four",
    jd.index %in% c(5:6) ~ "Five to six"
  ))

  IR$wd.nacnt<-IR  %>%
    rowwise() %>%
    summarise(wd.nacnt = sum(is.na(wd.hlth), is.na(wd.fp), is.na(wd.lrgpur), is.na(wd.visit), is.na(wd.money), is.na(wd.ownincome)))

  IR<-IR %>%
    rowwise() %>%
    mutate(wd.sum = sum(wd.hlth, wd.fp, wd.lrgpur, wd.visit, wd.money, wd.ownincome, na.rm=TRUE))

  IR$wd.index <- ifelse(IR$wd.nacnt == 6, NA, IR$wd.sum)
  IR$wd.index <- as.numeric(IR$wd.index)


  ###################################
  # Binary version, 0 = women make no decisions
  IR$wd.index.none <- ifelse(IR$wd.index<1,1,0)
  IR$wd.index.none[IR$marr.cohab==0] <- 0

  IR$jdwd.nacnt<-IR  %>%
    rowwise() %>%
    summarise(jdwd.nacnt = sum(is.na(jdwd.hlth), is.na(jdwd.fp), is.na(jdwd.lrgpur), is.na(jdwd.visit), is.na(jdwd.money), is.na(jdwd.ownincome)))

  IR<-IR %>%
    rowwise() %>%
    mutate(jdwd.sum = sum(jdwd.hlth, jdwd.fp, jdwd.lrgpur, jdwd.visit, jdwd.money, jdwd.ownincome, na.rm=TRUE))

  IR$jdwd.index <- ifelse(IR$jdwd.nacnt == 6, NA, IR$jdwd.sum)
  IR$jdwd.index <- as.numeric(IR$jdwd.index)


  ###################################
  # binary version, 1 = more decision making
  IR$jdwd.index.5plus <- ifelse(IR$jdwd.index>=5,1,0)
  IR$jdwd.index.5plus[IR$marr.cohab==0] <- 0


  ###################################
  # Categorical
  IR <- IR %>% mutate(jdwd.index.cat = case_when(
    marr.cohab == 0 ~ "Not partnered",
    jdwd.index == 0 ~ "None",
    jdwd.index %in% c(1:4) ~ "One to four",
    jdwd.index %in% c(5:6) ~ "Five to six"
  ))


  ###################################
  # Barriers to medical care for self - getting permission
  #note that the response category "not a problem" is blank
  IR <- IR %>% mutate(med.permis = case_when(
    v467b =="not a big problem" | v467b =="not a problem" ~0,
    v467b == "big problem" ~1))


  ###################################
  # Barriers to medical care for self - getting money needed for treatment
  IR<- IR %>% mutate(med.cost = case_when(
    v467c =="not a big problem" | v467c =="not a problem" ~0,
    v467c == "big problem" ~1))


  ###################################
  # WOMEN'S EMPOWERMENT INDEX

  SWPR<-cbind(SWPR, computeSWPER(SWPR))
  SWPR <- SWPR %>% select(c("caseid", "SWPER.SCORE.1", "SWPER.SCORE.2", "SWPER.SCORE.3", "SWPER.EMPOWERMENT.1", "SWPER.EMPOWERMENT.2", "SWPER.EMPOWERMENT.3"))


  ######################################################################
  # 4 | HOUSEHOLD ECONOMICS
  ######################################################################


  ###################################
  # Type of work
  IR$work.type <- factor(IR$v717)

  IR$work.type.prof<-ifelse(IR$work.type=="professional/technical/managerial" | IR$work.type=="clerical",1,0)


  ###################################
  # Assets

  # Electricity
  HH <- HH %>% mutate(hh.electricity = case_when(
    hv206 == "yes" ~ 1,
    hv206 == "no" ~ 0))

  # Radio
  HH <- HH %>% mutate(hh.radio = case_when(
    hv207 == "yes" ~ 1,
    hv207 == "no" ~ 0))

  # Television
  HH <- HH %>% mutate(hh.tv = case_when(
    hv208 == "yes" ~ 1,
    hv208 == "no" ~ 0))

  # Refrigerator
  HH <- HH %>% mutate(hh.refrig = case_when(
    hv209 == "yes" ~ 1,
    hv209 == "no" ~ 0))

  # Bicycle
  HH <- HH %>% mutate(hh.bike = case_when(
    hv210 == "yes" ~ 1,
    hv210 == "no" ~ 0))

  # Motorcycle
  HH <- HH %>% mutate(hh.motor = case_when(
    hv211 == "yes" ~ 1,
    hv211 == "no" ~ 0))

  # Car
  HH <- HH %>% mutate(hh.car = case_when(
    hv212 == "yes" ~ 1,
    hv212 == "no" ~ 0))

  # Mobile phone
  HH <- HH %>% mutate(hh.phone = case_when(
    hv243a == "yes" ~ 1,
    hv243a == "no" ~ 0))

  # Watch
  HH <- HH %>% mutate(hh.watch = case_when(
    hv243b == "yes" ~ 1,
    hv243b == "no" ~ 0))

  # Animal-drawn cart
  HH <- HH %>% mutate(hh.cart = case_when(
    hv243c == "yes" ~ 1,
    hv243c == "no" ~ 0))

  # Boat with a motor
  HH <- HH %>% mutate(hh.motorboat = case_when(
    hv243d == "yes" ~ 1,
    hv243d == "no" ~ 0))

  #note cart has zero associations with the outcomes and almost nobody owns a motorboat. Biking with a baby to a clinic may be difficult.
  HH$hh.motortransport.yn <- ifelse(HH$hh.motor==1 | HH$hh.car==1,1,0)

  # Computer
  HH <- HH %>% mutate(hh.computer = case_when(
    hv243e == "yes" ~ 1,
    hv243e == "no" ~ 0))

  # Own land usable for agriculture
  HH <- HH %>% mutate(hh.land = case_when(
    hv244 == "yes" ~ 1,
    hv244 == "no" ~ 0))

  # Hectares for agricultural land
  HH <- HH %>% mutate(hh.land.ha = case_when(
    hv244 == "no" ~ "0",
    hv245 %in% c(1:5) ~ "0.1-0.5 ha",
    hv245 %in% c(6:10) ~ "0.6-1.0 ha",
    hv245 %in% c(10:950) ~ "More than 1.0 ha",
    hv245 %in% c(998, 999) ~ "Unknown"))

  # Livestock, herds, or animals
  HH <- HH %>% mutate(hh.animal = case_when(
    hv246 == "yes" ~ 1,
    hv246 == "no" ~ 0))

  # Any cattle
  HH <- HH %>% mutate(asset.cattle = case_when(
    hv246a %in% c(1:98) ~ 1, ## Assume they have animals (but don't know how many) if they said 98
    hv246a %in% c(0) ~ 0))

  # Any cows, bulls
  HH <- HH %>% mutate(asset.cows = case_when(
    hv246b %in% c(1:98) ~ 1, ## Assume they have animals (but don't know how many) if they said 98
    hv246b %in% c(0) ~ 0))

  # Any horses, donkeys, mules
  HH <- HH %>% mutate(asset.horses = case_when(
    hv246c %in% c(1:98) ~ 1, ## Assume they have animals (but don't know how many) if they said 99
    hv246c %in% c(0) ~ 0))

  # Any goats
  HH <- HH %>% mutate(asset.goats = case_when(
    hv246d %in% c(1:98) ~ 1, ## Assume they have animals (but don't know how many) if they said 99
    hv246d %in% c(0) ~ 0))

  # Any sheep
  HH <- HH %>% mutate(asset.sheep = case_when(
    hv246e %in% c(1:98) ~ 1, ## Assume they have animals (but don't know how many) if they said 99
    hv246e %in% c(0) ~ 0))

  # Any chickens/poultry
  HH <- HH %>% mutate(asset.chickens = case_when(
    hv246f %in% c(1:98) ~ 1, ## Assume they have animals (but don't know how many) if they said 99
    hv246f %in% c(0) ~ 0))

  # Number of types of livestock
  HH <- HH %>%
    rowwise() %>%
    mutate(asset.livestock.types = sum(asset.cattle, asset.cows, asset.horses, asset.goats, asset.sheep, asset.chickens, na.rm=TRUE))

  # Table
  if (all(c('sh121g') %in% names(HH))){
    HH <- HH %>% mutate(hh.table = case_when(
      sh121g == "yes" ~ 1,
      sh121g == "no" ~ 0))
  } else {print("sh121g does not exist in HH")}

  # Chair
  HH <- HH %>% mutate(hh.chair = case_when(
    sh121h == "yes" ~ 1,
    sh121h == "no" ~ 0))

  # Bank account
  HH <- HH %>% mutate(hh.bank.acct = case_when(
    hv247=="no" | hv247 == "don't know" ~0,
    hv247 == "yes" ~1))

  # Wealth index combined
  HH$wealth.index <- factor(HH$hv270)

  # Wealth index urban/rural
  HH$wealth.index.ur <- factor(HH$hv270a)

  # Binary urban/rural wealth index -
  HH$wealth.index.poor <- ifelse(HH$wealth.index.ur=="poorest", 1, 0)

  # Ordinal urban/rural wealth index
  #1 is poorest
  HH$wealth.index.ur.ord <- as.integer(HH$wealth.index.ur)


  ###################################
  # Respondent works
  IR <- IR %>% mutate(working = case_when(
    (v714 == "yes" & (v714a != "yes" | is.na(v714a))) ~ "Currently working",
    (v714a == "yes") ~ "On leave/absent",
    (v731 == "no") ~ "No work in the past 12 months",
    (v731 == "in the past year") ~ "Worked in the past year"))

  IR$working.yn <- ifelse(IR$working=="Currently working" | IR$working=="Worked in the past year" | IR$working=="On leave/absent",1,0)

  IR$workingnow.yn <- ifelse(IR$working=="Currently working",1,0)


  ###################################
  # work seasonality
  IR <- IR %>% mutate(work.seasonal = case_when(
    v731 == "no" ~ "No work in the past 12 months",
    v732 == "occasional" ~ "Occassional",
    v732 == "seasonal" ~ "Seasonal",
    v732 == "all year" ~ "All  year"))


  ###################################
  # Partner working
  IR <- IR %>% mutate(partner.working = case_when(
    is.na(v704a) ~ "No current partner",
    v704a == "didn't work last 12 months" ~ "Didn't work last 12 months",
    v704a == "worked last 7 days" ~ "Worked last 7 days",
    v704a == "worked last 12 months" ~ "Worked last 12 months",
    v704a == "don't know" ~ "Don't know"))

  IR$partner.working.yn <- ifelse(IR$partner.working %in% c("Worked last 7 days", "Worked last 12 months"), 1, 0)

  IR$partner.workingnow.yn <- ifelse(IR$partner.working %in% c("Worked last 7 days"), 1, 0)


  ######################################################################
  # 5 | HEALTHCARE AND MENTAL MODELS
  ######################################################################


  ###################################
  # ABILITY TO CONCEIVE
  IR$infecund.meno <- ifelse(IR$v625 == "infecund, menopausal", 1,
                             ifelse(!(is.na(IR$v625)), 0, NA))


  ###################################
  # Husband/partner opposes FP use
  IR <- IR %>% mutate(fp.partner.oppose = case_when(
    v3a08j == "yes" ~ "Partner opposes",
    v3a08j == "no" ~ "Partner does not oppose",
    is.na(v3a08j) ~ "No identified need for FP")) # could break this down further by using FP, want more kids, no sex in past year


  ###################################
  # Barriers to HC
  #note that "not a problem" is blank throughout

  # don't know where to go
  IR <- IR %>% mutate(med.dnk = case_when(
    v467a =="not a big problem" | v467a =="not a problem" ~0,
    v467a == "big problem" ~1))

  # THIS VARIABLE GENERATED ABOVE IN DECISIONMAKING
  # # permission to go to health facility
  # IR <- IR %>% mutate(med.permis = case_when(
  #   v467b =="not a big problem" | v467b =="not a problem" ~0,
  #   v467b == "big problem" ~1))

  # cost for necessary treatment
  IR <- IR %>% mutate(med.cost = case_when(
    v467c =="not a big problem" | v467c =="not a problem" ~0,
    v467c == "big problem" ~1))

  #distance to health facility
  IR <- IR %>% mutate(med.dist = case_when(
    v467d =="not a big problem" | v467d =="not a problem" ~0,
    v467d == "big problem" ~1))

  #transportation to health facility
  IR <- IR %>% mutate(med.transp = case_when(
    v467e =="not a big problem" | v467e =="not a problem" ~0,
    v467e == "big problem" ~1))

  #doesn't want to go alone
  IR <- IR %>% mutate(med.alone = case_when(
    v467f =="not a big problem"| v467f =="not a problem" ~0,
    v467f == "big problem" ~1))

  #concern there may not be a female health provider
  IR <- IR %>% mutate(med.fempro = case_when(
    v467g =="not a big problem" | v467g =="not a problem"  ~0,
    v467g == "big problem" ~1))

  #concern there may not be a provider
  IR <- IR %>% mutate(med.nopro = case_when(
    v467h =="not a big problem"| v467g =="not a problem" ~0,
    v467h == "big problem" ~1))

  #concern there may not be medications
  IR <- IR %>% mutate(med.nomeds = case_when(
    v467i =="not a big problem" | v467i =="not a problem" ~0,
    v467i == "big problem" ~1))

  # index
  #mutated above so that 1 is a big problem, the rest is zero
  IR$med.nacnt <- IR  %>%
    rowwise() %>%
    summarise(med.nacnt = sum(is.na(med.dnk), is.na(med.permis), is.na(med.cost), is.na(med.dist), is.na(med.transp), is.na(med.alone), is.na(med.fempro), is.na(med.nopro), is.na(med.nomeds)))

  IR<-IR %>%
    rowwise() %>%
    mutate(med.sum = sum(med.dnk, med.permis, med.cost, med.dist, med.transp, med.alone, med.fempro, med.nopro, med.nomeds, na.rm=TRUE))

  IR$med.index <- ifelse(IR$med.nacnt == 9, NA, IR$med.sum)
  IR$med.index <- as.numeric(IR$med.index)

  # Binary indicator from index - larger is more problems
  IR$med.index.3plus<-ifelse(IR$med.index>=3,1,0)


  ######################################################################
  # 6 | LARGER ENVIRONMENT
  ######################################################################


  ###################################
  # Air quality in the house / ventilation
  HH <- HH %>% mutate(hh.where.cook = case_when(
    hv226 == "no food cooked in house" ~ "No food cooked in house",
    hv226 == "outdoors" ~ "Food cooked outdoors",
    hv241 == "in a separate building" ~ "Food cooked in a separate building",
    hv241 == "other" ~ "Other",
    hv241 == "in the house" & hv242 == "yes" ~ "Food cooked inside in a separate kitchen",
    hv241 == "in the house" & hv242 == "no" ~ "Food cooked inside"))

  HH <- HH %>% mutate(hh.cook.inside = case_when(
    hh.where.cook %in% c("No food cooked in house", "Food cooked outdoors", "Other") ~ "No",
    hh.where.cook %in% c("Food cooked inside in a separate kitchen", "Food cooked in a separate building") ~ "In a separate building/room",
    hh.where.cook %in% c("Food cooked inside") ~ "Yes"))

  HH$hh.cook.inside.yn<-ifelse(HH$hh.cook.inside=="Yes",1,0)


  ###################################
  # Number of rooms for sleeping
  HH <- HH %>% mutate(hh.rooms = case_when(
    hv216 == 1 ~ "1",
    hv216 == 2 ~ "2",
    hv216 == 3 ~ "3",
    hv216 >= 4 & !is.na(hv216) ~ "4+"))

  HH$hh.rooms.2plus<-ifelse(HH$hh.rooms=="1",0,1)

  HH$hh.rooms.num <- HH$hv216


  ###################################
  # Type of toilet facility
  HH$latrine <- ifelse(HH$hv205 %in% c("pit toilet latrine", "ventilated improved pit latrine (vip)", "pit latrine without slab/open pit",
                                       "no facility/bush/field", "composting toilet", "bucket toilet", "hanging toilet/latrine", "other"), 1,0)

  HH$toilet.facility <- ifelse(HH$hv205 %in% c("no facility/bush/field", "no facility"), 0,1)


  ###################################
  # Location of toilet facility
  HH <- HH %>% mutate(toilet.loc = case_when(
    hv205 =="no facility/bush/field" ~ "No facility/bush/field",
    hv238a == "in own dwelling" ~ "In own dwelling",
    hv238a == "in own yard/plot" ~ "In own yard/plot",
    hv238a == "elsewhere" ~"Elsewhere"
  ))


  ###################################
  # Source of drinking water
  HH$water <- ifelse(HH$hv201 %in% c("piped water", "piped into dwelling", "piped to yard/plot", "piped to neighbor", "public tap/standpipe",
                                     "tube well water", "tube well or borehole", "protected well", "tanker truck",
                                     "cart with small tank", "bottled water"), 0, 1)


  ###################################
  # Place of residence
  HH<-HH %>% mutate(hh.urban = case_when(
    hv025=="rural" ~ 0,
    hv025== "urban" ~ 1))


  ###################################
  # Urban slum - UN definition
  HH$floor <- ifelse(HH$hv213 == "earth, sand" | HH$hv213== "dung" | HH$hv213== "wood planks" | HH$hv213== "palm, bamboo",1,0)

  HH$wall <- ifelse(HH$hv214 == "no walls" | HH$hv214== "cane / palm / trunks" | HH$hv214== "dung / mud / sod" | HH$hv214== "grass" |
                    HH$hv214 == "bamboo with mud" | HH$hv214 == "stone with mud" | HH$hv214 == "uncovered adobe" |
                    HH$hv214 == "cardboard" | HH$hv214 == "reused wood" | HH$hv214 == "iron sheets", 1, 0)

  HH$members<-ifelse(HH$hv012 == 0, HH$hv013, HH$hv012)

  HH$memsleep <- ifelse(HH$hh.rooms.num == 0, HH$members, HH$members/HH$hh.rooms.num)

  HH$living <- ifelse(HH$memsleep > 3,1,0)

  HH<-HH %>%
    rowwise() %>%
    mutate(slum.sum = sum(floor, water, latrine, living, na.rm=T))

  HH<-HH %>% mutate(slum1 = case_when(
    hv025=="rural" ~ "rural",
    (hv025 == "urban" & slum.sum >= 2) ~ "urban slum",
    (hv025 == "urban" & slum.sum < 2) ~ "urban non-slum"))

  # Urban slum 2 - Zulu et al, 2002
  HH$piped <- ifelse(HH$hv201 == "piped water" | HH$hv201== "piped into dwelling" | HH$hv201== "piped to yard/plot" | HH$hv201== "public tap/standpipe", 0,1)
  HH$slum2 <- ifelse(HH$hh.urban == 1 & HH$hh.electricity == 0 & HH$latrine == 1 & HH$piped == 1, 1, 0)


  ###################################
  # Water treatment
  ## Anything done to make water safe to drink
  HH <- HH %>% mutate(hh.watpur = case_when(
    hv237 %in% c("yes") ~ 1,
    hv237 %in% c("no", "don't know") ~ 0))


  ###################################
  ## Approach to water purification, code as 0 if they don't purify in the appropriate ways
  #boil, add bleach/chlorine, strain through cloth, use water filter, solar disinfection, let it stand and settle
  HH <- HH %>% mutate(hh.watpur.appr = case_when(
    hh.watpur == 0 ~ 0,
    (hv237a == "yes" | hv237b == "yes" | hv237c == "yes" | hv237d == "yes" |
       hv237e == "yes" | hv237f == "yes") ~ 1,
    (hh.watpur == 1 & !(hv237a == "yes" | hv237b == "yes" | hv237c == "yes" | hv237d == "yes" |
                          hv237e == "yes" | hv237f == "yes")) ~ 0))


  ###################################
  # Time to get water
  HH <- HH %>% mutate(hh.wat.time = case_when(
    hv204 %in% c(0:10) ~ "0-10 mintues",
    hv204 %in% c(11:20) ~ "11-20 minutes",
    hv204 %in% c(21:30) ~ "21-30 minutes",
    hv204 %in% c(31:990) ~ ">30 minutes",
    hv204 %in% c(996) ~ "Water on premises"))

  HH$hh.wat.time.yn <- ifelse(HH$hh.wat.time=="Water on premises",1,0)


  ###################################
  # Water interrupted
  HH <- HH %>% mutate(hh.wat.interrupt = case_when(
    hv201a %in% c("no, not interrupted for a full day", "don't know") ~ "No / don't know",
    hv201a %in% c("yes, interruped for a full day or more") ~ "Yes",
    is.na(hv201a) & !is.na(hv201) ~ "Water from a source other than piped, well/borehole"))

  # Water is not piped or from a well/borehole
  HH <- HH %>% mutate(hh.wat.notpiped.yn = case_when(
    hh.wat.interrupt == "No / don't know" ~ 0,
    hh.wat.interrupt == "Water from a source other than piped, well/borehole" ~ 1,
    hh.wat.interrupt == "Yes" ~ 0))


  ###################################
  # Sanitation ==> not sure how useful this will be, because place of washing was not observed for a large proportion
  HH <- HH %>% mutate(hh.sanitation = case_when(
    (hv230b == "water is available" & hv232 == "yes") ~ "Water and soap observed",
    (hv230b == "water is available" & hv232 == "no") ~ "Water but no soap observed",
    (hv230b == "water not available" & hv232 == "yes") ~ "Soap but no water observed",
    (hv230b == "water not available" & hv232 == "no") ~ "No water or soap observed",
    hv230a %in% c("not observed: not in dwelling", "not observed: no permission to see",
                  "not observed: other reason") ~ "Washing place not observed"))

  #hand washing station observed
  HH$hh.sanitation.yn<-ifelse(HH$hh.sanitation=="Washing place not observed" |
                                HH$hh.sanitation=="No water or soap observed",0,1)


  ###################################
  # Female genital mutilation
  #this was asked of women who had heard of it (g100), but even g100 has many NA. Assuming NA is 0, but I'm not certain that is appropriate.
  #Note that for 'sewn close' there are more 'don't know' g104. People may not want to discuss this.

  IR$female.circumcision.yn <- ifelse(IR$g102=="yes",1,0)


  ######################################################################
  # MERGE TOGETHER TO CREATE DATASET COMBINING OUTCOMES AND VULNERABILITIES
  ######################################################################

  # RENAME JOINING VARIABLES
  HH$v001 <- HH$hv001
  HH$v002 <- HH$hv002
  IR$wt <- IR$v005/1000000


  ###################################
  #select variables
  # dropping some variables that were created as intermediaries in construction of the target var
  # dropping some variables that were created as intermediaries in construction of the target var

  #v131-ethnicity, #g102 circumcision
  IR.seg <- IR %>% select(c("v001","v002","v005","v021","v023", "v024", "v201", "wt", "caseid", "ed.lev", "age.yrs":"med.index.3plus"))

  IR.seg <- IR.seg %>% select(-c("dv.nacnt", "dv.sum", "child.pref.discrep",
                                 "no.partner", "jd.nacnt", "wd.nacnt", "wd.sum", "jd.sum", "med.sum"))

  HH.seg <- HH %>% select(c("v001", "v002", "num.15up", "num.15up.cat", "num.15up.4plus", "num.under15", "num.under15.cat", "highestyearsedinHH.yrs",
                            "highestyearsedinHH.7plus", "num.under15.3plus", "hh.kidwom.rat":"hh.urban", "slum1", "slum2":"hh.sanitation.yn",
                            "hv021","hv022", "hv023", "hv024", "hv025", "hh.rooms.num", "wealth.index.ur", "wealth.index.ur.ord", "hh.electricity", "hh.land",
                            "asset.goats", "asset.sheep", "asset.chickens", "toilet.facility", "water", "hh.cook.inside.yn", "hh.rooms.2plus"))
  BR.seg <- BR %>% select(c("caseid", "kids.under5":"num.kids.away.cat"))

  BR.seg <- BR.seg %>% select(-c("lives.away"))

  ## Collapse BR to one line per woman
  BR.seg <- BR.seg %>% group_by(caseid) %>%
    filter(row_number() ==1)

  ###################################
  # MERGE TOGETHER IR, HH, AND BR DATASETS
  vulnerability <- base::merge(IR.seg, HH.seg, by=c("v001", "v002"), all.x=T)
  vulnerability <- base::merge(vulnerability, SWPR, by="caseid", all.x=T)
  vulnerability <- base::merge(vulnerability, BR.seg, by="caseid", all.x=T)


  ###################################
  # CREATE SEGMENTATION SUBGROUPS
  vulnerability <- vulnerability %>%
    mutate(seg_subgroup = case_when((hh.urban == 1 & marr.cohab == 1) ~ "urban_partnered",
                                    (hh.urban == 1 & marr.cohab == 0) ~ "urban_unpartnered",
                                    (hh.urban == 0 & marr.cohab == 1) ~ "rural_partnered",
                                    (hh.urban == 0 & marr.cohab == 0) ~ "rural_unpartnered"))


  ###################################
  return(vulnerability)
}
