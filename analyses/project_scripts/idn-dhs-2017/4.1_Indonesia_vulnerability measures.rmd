---
title: "4.1[for PCA]_Indonesia_DHS_vulnerability measures"
author: "Lang Gao"
date: "2023-09-25"
output: html_document
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '6'
  word_document:
    toc: yes
    toc_depth: '6'
  pdf_document:
    toc: yes
    toc_depth: '6'
---

<style type="text/css">

h1.title {
  font-size: 21px;
  color: Blue;
  text-align: center;
}
h4.author { /* Header 4 - and the author and data headers use this too  */
    font-size: 18px;
  font-family: "Source Sans Pro Semibold", Times, serif;
  color: Blue;
  text-align: center;
}
h4.date { /* Header 4 - and the author and data headers use this too  */
  font-size: 18px;
  font-family: "Source Sans Pro Semibold", Times, serif;
  color: Blue;
  text-align: center;
}
</style>

</br>


***
---

#######################################
1. Setting up the script
#######################################

Set up filepath, notation and packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(scipen = 100, digits = 4)

#Set filepath
setwd("/Users/langgao/Downloads/Freelancer projects/Sonder/Indonesia/Segmentation")
```

Load packages
```{r,echo=TRUE}
rm(list=ls())
pacman::p_load("foreign", "stringr", "magrittr", "reshape2", "data.table", "psych", "vtable", "corrplot", "haven", "survey", "ggplot2", "dplyr", "tidyr")
```

Load data
```{r}
#did not use KR (child record) when recoding for vulnerability measures
BR <-  data.table(read_dta("IDBR71FL.DTA"))
HH <-  data.table(read_dta("IDHR71FL.DTA"))
IR <-  data.table(read_dta("IDIR71FL.DTA"))
MR <-  data.table(read_dta("IDMR71FL.DTA"))
#dim(BR) #86265  1694 (now that dataset named the same as script 1, new variables are included)
#dim(HH) #47963  1283
#dim(IR) #49627  5529 (now that dataset named the same as script 1, new variables are included)
#dim(MR) #10009   715
BR$caseid <- str_trim(BR$caseid)
HH$hhid <- str_trim(HH$hhid)
IR$caseid <- str_trim(IR$caseid)
MR$mcaseid <- str_trim(MR$mcaseid)
```

Load SWPR empowerment scale files
```{r}
# First re-load the IR file from the DHS
SWPR<-data.table(read.dta("IDIR71FL.DTA"))
SWPR$caseid <- str_trim(SWPR$caseid)
#Then use the dhs_swper R code to computes the SWPR codes
#rmarkdown::render("2_dhs_swper.Rmd") #error solved; the previous one was a R markdown format, should use rmarkdown render instead of source.
source("2_dhs-swper.R")
computeSWPER(SWPR)
```

#######################################
2. Vulnerability Measures from 6 Domains
#######################################

##2.1. Woman and her past experiences
### 2.1.1. Women's age
```{r}
#v012: current age in completed years, calculated from the CMC v011 and v008
IR$age.yrs <- IR$v012
```

### 2.1.2. Women's education and highest edu in HH
```{r}
#v149: Educational achievement recodes the education of the respondent into the following categories: None (==0), incomplete primary (==1), complete primary (==2), incomplete secondary (==3), complete secondary (==4), higher education (==5). s107: women even attended school (yes/no)
IR$ed.lev <- factor(IR$v149)
#levels(IR$ed.lev)
#table(IR$ed.lev) #only 2% has none edu
#sum(!is.na(IR$ed.lev)) #no missing data

#Create a new category based on the 1st round of exploratory, in which we saw clear cutoff between no vs. higher education, and no clear cutoff otherwise. 
IR <- IR %>% 
  mutate(ed.lev.cat1 = case_when(
    ed.lev == 0 ~ "No eduction",
    ed.lev %in% (1:4) ~ "Some eduction",
    ed.lev == 5 ~ "Higher education"
  ))
#table(IR$ed.lev.cat1) #character 

#Another way of regrouping, like how we regroup husb.edu
IR <- IR %>% 
  mutate(ed.lev.cat2 = case_when(
    ed.lev == (0:2) ~ "Primary or less",
    ed.lev %in% (3:5) ~ "At least some secondary"
  ))
#table(IR$ed.lev.cat2) #character

IR$anyed.yn <- ifelse(IR$v149 == 0, 0, 1)
#class(IR$anyed.yn) #numeric
#table(IR$anyed.yn), this would be the same if creating a binary using s107 (or v106)
#sum(904,48723)

IR$ed.lev.ord <- as.integer(IR$ed.lev)
#v107: highest grade at that level, from question s109:What is the highest [GRADE/YEAR] you completed at that level? #0=="no years completed at level v106", 98=="	don't know"
IR$ed.grade.compl <- ifelse(IR$v107 == 0 | IR$v107 == 98, 0, 1) #0=="no years completed at the level"
#table(IR$v108)

# Women's education in single years
IR$women.ed.year <- IR$v133

#Highest level of education of anyone in the HH 
    #Using hv108, 'education completed in single years', constructed from the educational level (HV106) and the and the grade at that level (HV107), because hv107 'highest year of education completed' only gives the years of education completed at the level given in HV106.
    #98 is 'don't know' or in some cases 'incomplete primary' (but without number of years). Here we impute the "98" as the mean number of years to complete primary, assuming that those who said "don't know" because they did not complete primary and said so due to social desirability bias. The percentage of "98" is 0.18% or less. 
    #consider: 16+ or 17+ together due to low sample size (?) 16 (371), 17(7789), 18(174)

#table(HH$hv107_11)
#HH$hv108_24
  HH$hv108_01 <- ifelse(HH$hv108_01 == 98, 3, HH$hv108_01)
  HH$hv108_02 <- ifelse(HH$hv108_02 == 98, 3, HH$hv108_02)
  HH$hv108_03 <- ifelse(HH$hv108_03 == 98, 3, HH$hv108_03)
  HH$hv108_04 <- ifelse(HH$hv108_04 == 98, 3, HH$hv108_04)
  HH$hv108_05 <- ifelse(HH$hv108_05 == 98, 3, HH$hv108_05)
  HH$hv108_06 <- ifelse(HH$hv108_06 == 98, 3, HH$hv108_06)
  HH$hv108_07 <- ifelse(HH$hv108_07 == 98, 3, HH$hv108_07)
  HH$hv108_08 <- ifelse(HH$hv108_08 == 98, 3, HH$hv108_08)
  HH$hv108_09 <- ifelse(HH$hv108_09 == 98, 3, HH$hv108_09)
  HH$hv108_10 <- ifelse(HH$hv108_10 == 98, 3, HH$hv108_10)
  HH$hv108_11 <- ifelse(HH$hv108_11 == 98, 3, HH$hv108_11)
  HH$hv108_12 <- ifelse(HH$hv108_12 == 98, 3, HH$hv108_12)
  HH$hv108_13 <- ifelse(HH$hv108_13 == 98, 3, HH$hv108_13)
  HH$hv108_14 <- ifelse(HH$hv108_14 == 98, 3, HH$hv108_14)
  HH$hv108_15 <- ifelse(HH$hv108_15 == 98, 3, HH$hv108_15)
  HH$hv108_16 <- ifelse(HH$hv108_16 == 98, 3, HH$hv108_16)
  HH$hv108_17 <- ifelse(HH$hv108_17 == 98, 3, HH$hv108_17)
  HH$hv108_18 <- ifelse(HH$hv108_18 == 98, 3, HH$hv108_18)
  HH$hv108_19 <- ifelse(HH$hv108_19 == 98, 3, HH$hv108_19)
  HH$hv108_20 <- ifelse(HH$hv108_20 == 98, 3, HH$hv108_20)
  HH$hv108_21 <- ifelse(HH$hv108_21 == 98, 3, HH$hv108_21)
  HH$hv108_22 <- ifelse(HH$hv108_22 == 98, 3, HH$hv108_22)
  HH$hv108_23 <- ifelse(HH$hv108_23 == 98, 3, HH$hv108_23)
  HH$hv108_24 <- ifelse(HH$hv108_24 == 98, 3, HH$hv108_24)
#max yr = 18 yrs    
#table(HH$hv108_18)

HH$highestyearsedinHH.yrs <- pmax(HH$hv108_01, HH$hv108_02, HH$hv108_03, HH$hv108_04, HH$hv108_05, HH$hv108_06, HH$hv108_07, HH$hv108_08, HH$hv108_09, HH$hv108_10, HH$hv108_11, HH$hv108_12, HH$hv108_13, HH$hv108_14, HH$hv108_15, HH$hv108_16, HH$hv108_17, HH$hv108_18, HH$hv108_19, HH$hv108_20, HH$hv108_21, HH$hv108_22, HH$hv108_23, HH$hv108_24,na.rm= TRUE)
#table(HH$highestyearsedinHH.yrs)
HH$highestyearsedinHH.7plus <- ifelse(HH$highestyearsedinHH.yrs>=7,1,0) #differentiating those who are beyond "completing primary"
```

### 2.1.3. Partnership status
```{r}
#v501: Current marital status of the respondent, from question
#IR$v501 #0=="never in union", 1=="married", 2=="living with partner", 3=="widowed", 4=="divorced", 5=="no longer living together/separated"
IR$pship.status <- factor(IR$v501)
#IR$pship.status
IR$marr.cohab<-ifelse(IR$v501 == 1 | IR$v501 == 2,1,0) # ==> consider revising cutoff or making another variable for ever partnered?
#sum(!is.na(IR$marr.cohab)) #no missing data
IR$ever.partnered.yn <- ifelse(IR$v501 == 0, 0, 1)

#Partnership by category
IR$pship.cat <- IR$pship.status

IR<- IR %>% mutate(pship.cat = case_when
      (
        pship.status == 0 ~ "never",
        pship.status == 3 ~ "no partner now",
        pship.status == 4 ~ "no partner now",
        pship.status == 5 ~ "no partner now",
        pship.status == 1 ~ "married/cohab",
        pship.status == 2 ~ "married/cohab"
      )
    )
#
#class(IR$pship.cat) #character
#table(IR$pship.cat) #married/cohab, never, no partner now 
#sum(34467,12701,2459) #49627, no missing data
```

### 2.1.4. Age at first marriage/cohabitation
```{r}
#v511: Age at start of first marriage or union (CMC)
#summary(IR$v511) #min.=10, max.=49, 12701 NAs from v501 == 0
IR$age.1stcohab <- IR$v511
#class(IR$age.1stcohab) #numeric
#table(IR$age.1stcohab)
#table(IR$v501) #the 0 are NAs for v511 (12701, never in union)
#table(IR$v511) #the min = 10
IR<- IR %>% mutate(age.1stcohab.cat = case_when(
  (v511 > 0 & v511 < 19) ~ "Yonger than 19",
  (v511 >= 19) ~ "19 or older",
  TRUE~ "Never in union"))
#table(IR$age.1stcohab.cat)
#class(IR$age.1stcohab.cat)

IR$early.cohab.19 <- ifelse(IR$age.1stcohab.cat == "Yonger than 19", 1, 0)
#class(IR$early.cohab.19) #numeric
#table(IR$early.cohab.19)
```

### 2.1.5. Age at first sex 
```{r}
#v525:Age at first sexual intercourse. Respondents who had never had sex are coded 0; and "at first union" is coded as 97. So use v531.
#v531: Age at first sexual intercourse (imputed), same as V525, except for respondents who reported "that their first sexual intercourse was at the time of their union"97" in v525 is imputed here from the age at first union.
#IR$v531 #0=="not had sex", 97=="inconsistent", 98=="don't know"
#table(IR$v531) #excluding 0, min = 8
IR$age.1stsex <- ifelse(IR$v531 == 97,NA,  
                             ifelse(IR$v531 == 98, NA, IR$v531))
#table(IR$v531) #12398 never had sex; 12701 (from v501) never in union. If using v531 == 97|98, leaving NAs which will cause errors later 
IR<- IR %>% mutate(age.1stsex.cat = case_when(
  v531 == 0 ~ "never had sex",
  (age.1stsex > 0 & age.1stsex < 19) ~ "8-18",
  (age.1stsex >= 19 & age.1stsex < 50) ~ "19 or older",
  TRUE ~ "Inconsistent or don't know"))
#table(IR$age.1stsex.cat)
#sum(12389,13292,22245,1701) #49627

IR$early.sex.17 <- ifelse(IR$v531 >0 & IR$v531 <17, 1, 0)
#table(IR$early.sex.17) #1 (6600)
IR$early.sex.19 <- ifelse(IR$v531 >0 & IR$v531 <19, 1, 0)
#table(IR$early.sex.19) #1 (13292)
```

### 2.1.6. Time from marriage to fist birth
```{r}
#v221: Interval between the first marriage and first birth in months. If the first birth was prior to the first marriage then this variable is coded 996 "Negative interval." BASE: Ever-married women who have had one or more births (V501 > 0 & V201 > 0). So, v221 excludes women who have had 1+ birthrs but never married.
#summary(IR$v221) #15473 NAs
IR$months.cohabbirth <- as.character(IR$v221)
#table(IR$months.cohabbirth)
#sum(is.na(IR$months.cohabbirth)) #15473
#table(IR$v201)
IR$months.cohabbirth[IR$v221 == 996] <- NA

IR<- IR %>% mutate(months.cohabbirth.cat = case_when( 
  v221 == 996 ~ "Before marriage",
  (v221 >= 0 & v221 < 10) ~ "0-9 months",
  (v221 >= 10 & v221 < 25) ~ "10-24 months",
  (v221 >= 25 & v221 < 61) ~ "25-60 months",
  (v221 >= 61 & v221 < 400) ~ ">61 months",
  TRUE ~ "never in union or given birth"))
#table(IR$months.cohabbirth.cat) #no missing data
```

### 2.1.7. Age at first birth
```{r}
#v212: Age of the respondent at first birth. BASE: All respondents with one or more births (V201 > 0).
#summary(IR$v212) #15428 NAs
IR$age.1stbrth<-IR$v212
#table(IR$v212) #min = 10
IR<- IR %>% mutate(age.1stbrth.cat = case_when(
  is.na(v212) ~ "no births",
  (v212 > 0 & v212 < 19) ~ "10-18",
  (v212 >= 19 & v212 < 25) ~ "19-24",
  (v212 >= 25 & v212 < 50) ~ "25+"))
#table(IR$age.1stbrth.cat)
#sum(7903,18183,8113,15428) #49627

IR$early.birth.19 <- ifelse(IR$age.1stbrth.cat =="10-18", 1, 0)
IR$early.birth.25 <- ifelse(IR$age.1stbrth.cat =="10-18" | IR$age.1stbrth.cat =="19-24", 1, 0)
#table(IR$early.birth.19) #1(7903)
#table(IR$early.birth.25) #26086
#sum(48813,814) #49627
```

### 2.1.8. Number of pregnancies
```{r}
#v201: Total number of children ever born.
#v228: Whether the respondent ever had a pregnancy that terminated in a miscarriage, abortion, or still birth, i.e., did not result in a live birth.yes == 1, no == 0
#v234: Whether the respondent had other pregnancy terminations before the last one.yes == 1, no == 1
#sum(is.na(IR$v201)) #no missing data
IR$num.preg <- IR$v201
IR$num.preg <- ifelse(IR$v228 == 1 & IR$v234 == 1, IR$v201 + 2,
                      ifelse(IR$v228 == 1 & IR$v234 == 0, IR$v201 + 1,
                             IR$v201))
#note that num.preg is not the total number of pregnancies, but the least number of pregnancies
IR$preg.2plus <- ifelse(IR$num.preg >=2 & !is.na(IR$num.preg), 1, 0)
IR$preg.3plus <- ifelse(IR$num.preg >=3 & !is.na(IR$num.preg), 1, 0)
IR$preg.4plus <- ifelse(IR$num.preg >=4 & !is.na(IR$num.preg), 1, 0)
#IR$preg.4plus is defining having 4 or more pregnancies as high number of pregnancies.

IR$num.preg <- ifelse(IR$num.preg >=12, 12, IR$num.preg) #to resolve the issue in script 5 when exploratory with levels of too small size
IR$num.preg <- as.factor(IR$num.preg)
#table(IR$num.preg)
```

### 2.1.9. Attitudes about domestic violence
```{r}
#v744a: She goes out without telling him; v744b: She neglects the children; v744c: She argues with him; v744d: She refuses to have sex with him; v744e: She burns the food. 0 == "n0", 1 == "yes", 8 == "don't know"
IR <- IR %>% 
  mutate(dv.out = case_when(v744a == 0 ~ 0, v744a == 1 ~ 1),
         dv.negkid = case_when(v744b == 0 ~ 0, v744b == 1 ~ 1),
         dv.argue = case_when(v744c == 0 ~ 0, v744c == 1 ~ 1),
         dv.nosex = case_when(v744d == 0 ~ 0, v744d == 1 ~ 1),
         dv.burnfd = case_when(v744e == 0 ~ 0, v744e == 1 ~ 1)) %>%
  mutate(dv.sum = if(all(is.na(c(dv.out, dv.negkid, dv.argue, dv.nosex, dv.burnfd)))) NA else dv.out + dv.negkid + dv.argue + dv.nosex + dv.burnfd, na.rm = TRUE)

#table(IR$dv.sum)
#sum(30649, 6902, 5759, 2271, 891, 455) #46927

IR$dv.index.2 <- ifelse(IR$dv.sum %in% c(2:5), 1, 
                         ifelse(IR$dv.sum %in% c(0:1), 0, NA))
IR$dv.index.3 <- ifelse(IR$dv.sum %in% c(3:5), 1, 
                         ifelse(IR$dv.sum %in% c(0:2), 0, NA))
IR$dv.index.4 <- ifelse(IR$dv.sum %in% c(4, 5), 1, 
                         ifelse(IR$dv.sum %in% c(0:3), 0, NA))
#table(IR$dv.index.2)
#table(IR$dv.index.3)
#table(IR$dv.index.4)
```

Religion and ethnic questions are not found

### 2.1.10. Media exposure
```{r}
#v157: Reading a newspaper or magazine (frequency). Respondents who cannot read at all or who are blind/visually impaired (V155 = 0, 4) are code as “0”. 0 =="not at all", 1 == "less than a week", 2 == "at least once a week", 3 == "almost every day". v158: Listening to the radio. v159: Watching television. Checked the data, none chose "almost every day"
#v171b: in the past months, how often used Internet; 27 NAs;
#table(IR$v157) # 0(26644) 1(17308)  2(5608)
#sum(26644, 17308, 5608) #49560
IR<-IR %>% mutate(freq.newsp = case_when(
  (v157== 0 | is.na(v157)) ~ 0,
  v157==2 ~2,
  v157== 1 ~1))
IR$newsp.yn<-ifelse((IR$v157== 0 | is.na(IR$v157)),0,1)

IR<-IR %>% mutate(freq.rad = case_when(
  (v158== 0 | is.na(v158)) ~ 0,
  v158==2 ~2,
  v158== 1 ~1))
IR$rad.yn<-ifelse((IR$v158== 0 | is.na(IR$v158)),0,1)

IR<-IR %>% mutate(freq.tv = case_when(
  (v159==0 | is.na(v159)) ~ 0,
  v159 == 2 ~2,
  v159 == 1 ~1))
IR$tv.yn<-ifelse((IR$v159==0 | is.na(IR$v159)),0,1)

IR<-IR %>% mutate(freq.net = case_when(
  (v171b==0 | is.na(v171b)) ~ 0,
  v171b == 2 ~2,
  v171b == 1 ~1))
IR$net.yn <- ifelse((IR$v171b==0 | is.na(IR$v171b)),0,1)
#table(IR$net.yn)

IR <- IR %>% 
  mutate(media.sum = if(all(is.na(c(newsp.yn, rad.yn, tv.yn, net.yn)))) NA else newsp.yn + rad.yn + tv.yn + net.yn, na.rm = TRUE) %>% 
  mutate(media.sum = as.factor(media.sum))
#table(IR$media.sum)

IR <- IR %>% mutate(media.sum.2plus = case_when(
  (media.sum == "0" | media.sum == "1") ~ 0,
  TRUE ~ 1))
#table(IR$media.sum.2plus) #character
#sum(is.na(IR$media.sum))

IR <- IR %>% 
  mutate(media.source = case_when(
    (newsp.yn == 1) & !(rad.yn == 1 | tv.yn == 1 | net.yn == 1) ~ "Newspaper only",
    (rad.yn == 1) & !(newsp.yn == 1 | tv.yn == 1 | net.yn == 1) ~ "Radio only",
    (tv.yn == 1) & !(rad.yn == 1 | newsp.yn == 1 | net.yn == 1) ~ "TV only",
    (net.yn == 1) & !(rad.yn == 1 | tv.yn == 1 | newsp.yn == 1) ~ "Internet only",
    media.sum == "0" ~ "Discuss with no one",
    TRUE ~ "Multiple sources" 
  ))
#table(IR$media.source) #character #radio only, newspaper only, and Internet only are with sample sample
```

### 2.1.11. SRH knowledge (or shall we move it to Mental Model - information barrier)
```{r}
# Knowledge on danger signs during pregnancy. 
 #s714d: Do you know the signs of danger during pregnancy. 0=="no", 1=="yes"
IR$know.preg <- factor(IR$s714c)
#class(IR$know.preg)
#sum(is.na(IR$s714c))

# Knowledge on conception
  #v244: from question Q242: After the birth of a child, can a woman become pregnant before her menstrual period has returned? 0=="no", 1=="yes", 8=="don't know"
IR$know.conceive <- ifelse(IR$v244 == 1, 1, 0)
#class(IR$know.conceive)

# Heard of STI/HIV
IR$know.sti <- factor(IR$v750)
#class(IR$know.sti)

# Knowledge on anemia (small sample, unmarried 15-24, not used yet)
 #summary(IR$s1313) #38945 NAs
```

Age at first boyfriend (not used yet, small sample, unmarried 15-24)
```{r}
#summary(IR$s1701) #38946 NAs (Do you currently have a boyfriend?)
#summary(IR$s1702) #44098 NAs
#table(IR$s1703) #41094 NAs, assuming dk (98) means early age
IR <- IR %>% 
  mutate(age.1stbf = case_when(
    s1703 >0 & s1703 <15 | s1703 == 98 ~ "In relationship at an early age",
    s1703 >=15 & s1703 <97 ~ "In a relationship at 15 or older",
    is.na(s1703) ~ NA
  ))
#table(IR$age.1stbf)
```

Reason for 1st sex experience (not used yet, small sample, unmarried 15-24)
```{r}
#summary(IR$s1706) #49403 NAs
#sum(!is.na(IR$s1706)) #224
#summary(IR$s1724)
```

Health service by professionals (Decided to discard)
```{r}
#(kept notes in a copy)
```

Given iron tablets syrup in the last pregnancy
```{r}
#m45_1: from question 420. 0=="no", 1=="yes", 8=="don't know". This was taken out after the 1st round of exploratory: this is proximal to behavoir/outomes of healthcare seeking and ANC
IR$iron <- ifelse(IR$m45_1 == 1, 1, 0)
```

### 2.1.12. Smoking habit
```{r}
#IR$v463aa, 0=="do not smokes", 1=="every day", 2=="some days"
IR$smoke <-  ifelse(IR$v463aa == 0, 0, 1)
```

## 2.2. Household Relationships
Type of marriage, among married women
```{r}
#v505: Whether the respondent is in a polygynous union and the number of other wives the respondent's partner currently has. BASE: Currently married or in union women (V502 = 1).0 =="no other wives", 98 = "don't know"
#IR$v505 # all NAs. The question was not asked in the IR or HH. 
#sum(!is.na(IR$v505)) #0, IR$v505 all NAs. In the survey, Q706 (Husband has other wives) and Q707 (v505) are not included.

#In MR, men were asked how many wives they have. But the sample size of MR is much smaller than IR. Shall we still merge IR with MR to get the polygamy? In addition, the MR data suggests a very small portion of married men who reported having more than 1 wives.
#dim(MR) #10009   715
#table(MR$mv505)
#sum(9948,56,2,3) #10009
#sum(56,2,3) #61
#61/10009 #0.6%
#9948/10009 #99.4% #almost aligned with what the report says: in the Table A.4.1 Number of men's wives, 99.6% of currently married men have only 1 wife, 0.4% have 2 or more.
```

### 2.2.1. Number of adults (15+) in the household
```{r}
#hv105: Age of the household member. 95 == "95+", 98 == "don't know"
#sum(!is.na(HH$hv105_01)) #47959

# First impute unknown ages to the mean
HH$age_01 <- ifelse(HH$hv105_01 == 98, mean(HH$hv105_01, na.rm=TRUE), HH$hv105_01)
HH$age_02 <- ifelse(HH$hv105_02 == 98, mean(HH$hv105_02, na.rm=TRUE), HH$hv105_02)
HH$age_03 <- ifelse(HH$hv105_03 == 98, mean(HH$hv105_03, na.rm=TRUE), HH$hv105_03)
HH$age_04 <- ifelse(HH$hv105_04 == 98, mean(HH$hv105_04, na.rm=TRUE), HH$hv105_04)
HH$age_05 <- ifelse(HH$hv105_05 == 98, mean(HH$hv105_05, na.rm=TRUE), HH$hv105_05)
HH$age_06 <- ifelse(HH$hv105_06 == 98, mean(HH$hv105_06, na.rm=TRUE), HH$hv105_06)
HH$age_07 <- ifelse(HH$hv105_07 == 98, mean(HH$hv105_07, na.rm=TRUE), HH$hv105_07)
HH$age_08 <- ifelse(HH$hv105_08 == 98, mean(HH$hv105_08, na.rm=TRUE), HH$hv105_08)
HH$age_09 <- ifelse(HH$hv105_09 == 98, mean(HH$hv105_09, na.rm=TRUE), HH$hv105_09)
HH$age_10 <- ifelse(HH$hv105_10 == 98, mean(HH$hv105_10, na.rm=TRUE), HH$hv105_10)
HH$age_11 <- ifelse(HH$hv105_11 == 98, mean(HH$hv105_11, na.rm=TRUE), HH$hv105_11)
HH$age_12 <- ifelse(HH$hv105_12 == 98, mean(HH$hv105_12, na.rm=TRUE), HH$hv105_12)
HH$age_13 <- ifelse(HH$hv105_13 == 98, mean(HH$hv105_13, na.rm=TRUE), HH$hv105_13)
HH$age_14 <- ifelse(HH$hv105_14 == 98, mean(HH$hv105_14, na.rm=TRUE), HH$hv105_14)
HH$age_15 <- ifelse(HH$hv105_15 == 98, mean(HH$hv105_15, na.rm=TRUE), HH$hv105_15)
HH$age_16 <- ifelse(HH$hv105_16 == 98, mean(HH$hv105_16, na.rm=TRUE), HH$hv105_16)
HH$age_17 <- ifelse(HH$hv105_17 == 98, mean(HH$hv105_17, na.rm=TRUE), HH$hv105_17)
HH$age_18 <- ifelse(HH$hv105_18 == 98, mean(HH$hv105_18, na.rm=TRUE), HH$hv105_18)
HH$age_19 <- ifelse(HH$hv105_19 == 98, mean(HH$hv105_19, na.rm=TRUE), HH$hv105_19)
HH$age_20 <- ifelse(HH$hv105_20 == 98, mean(HH$hv105_20, na.rm=TRUE), HH$hv105_20)
HH$age_21 <- ifelse(HH$hv105_21 == 98, mean(HH$hv105_21, na.rm=TRUE), HH$hv105_21)
HH$age_22 <- ifelse(HH$hv105_22 == 98, mean(HH$hv105_22, na.rm=TRUE), HH$hv105_22)
HH$age_23 <- ifelse(HH$hv105_23 == 98, mean(HH$hv105_23, na.rm=TRUE), HH$hv105_23)
HH$age_24 <- ifelse(HH$hv105_24 == 98, mean(HH$hv105_24, na.rm=TRUE), HH$hv105_24)

# Categorize each member as 15+ or younger
# have to convert all NAs to 0 for now: all codes I've tried give NAs to all entries in the end when summing up. In the end will create a binary for differentiating 
HH <- HH %>%
  mutate(age15up_01 = ifelse(is.na(age_01), 0, ifelse(age_01 >= 15, 1, 0))) %>% 
  mutate(age15up_02 = ifelse(is.na(age_02), 0, ifelse(age_02 >= 15, 1, 0))) %>% 
  mutate(age15up_03 = ifelse(is.na(age_03), 0, ifelse(age_03 >= 15, 1, 0))) %>% 
  mutate(age15up_04 = ifelse(is.na(age_04), 0, ifelse(age_04 >= 15, 1, 0))) %>%
  mutate(age15up_05 = ifelse(is.na(age_05), 0, ifelse(age_05 >= 15, 1, 0))) %>%
  mutate(age15up_06 = ifelse(is.na(age_06), 0, ifelse(age_06 >= 15, 1, 0))) %>%
  mutate(age15up_07 = ifelse(is.na(age_07), 0, ifelse(age_07 >= 15, 1, 0))) %>%
  mutate(age15up_08 = ifelse(is.na(age_08), 0, ifelse(age_08 >= 15, 1, 0))) %>%
  mutate(age15up_09 = ifelse(is.na(age_09), 0, ifelse(age_09 >= 15, 1, 0))) %>%
  mutate(age15up_10 = ifelse(is.na(age_10), 0, ifelse(age_10 >= 15, 1, 0))) %>%
  mutate(age15up_11 = ifelse(is.na(age_11), 0, ifelse(age_11 >= 15, 1, 0))) %>%
  mutate(age15up_12 = ifelse(is.na(age_12), 0, ifelse(age_12 >= 15, 1, 0))) %>%
  mutate(age15up_13 = ifelse(is.na(age_13), 0, ifelse(age_13 >= 15, 1, 0))) %>%
  mutate(age15up_14 = ifelse(is.na(age_14), 0, ifelse(age_14 >= 15, 1, 0))) %>%
  mutate(age15up_15 = ifelse(is.na(age_15), 0, ifelse(age_15 >= 15, 1, 0))) %>%
  mutate(age15up_16 = ifelse(is.na(age_16), 0, ifelse(age_16 >= 15, 1, 0))) %>%
  mutate(age15up_17 = ifelse(is.na(age_17), 0, ifelse(age_17 >= 15, 1, 0))) %>%
  mutate(age15up_18 = ifelse(is.na(age_18), 0, ifelse(age_18 >= 15, 1, 0))) %>%
  mutate(age15up_19 = ifelse(is.na(age_19), 0, ifelse(age_19 >= 15, 1, 0))) %>%
  mutate(age15up_20 = ifelse(is.na(age_20), 0, ifelse(age_20 >= 15, 1, 0))) %>%
  mutate(age15up_21 = ifelse(is.na(age_21), 0, ifelse(age_21 >= 15, 1, 0))) %>%
  mutate(age15up_22 = ifelse(is.na(age_22), 0, ifelse(age_22 >= 15, 1, 0))) %>%
  mutate(age15up_23 = ifelse(is.na(age_23), 0, ifelse(age_23 >= 15, 1, 0))) %>%
  mutate(age15up_24 = ifelse(is.na(age_24), 0, ifelse(age_24 >= 15, 1, 0)))

HH <- HH %>% 
  mutate(num.15up = age15up_01 + age15up_02 + age15up_03 + age15up_04 + age15up_05 + age15up_06 + age15up_07 + age15up_08 + age15up_09 + age15up_10 + age15up_11 + age15up_12 + age15up_13 + age15up_14 + age15up_15 + age15up_16 + age15up_17 + age15up_18 + age15up_19 + age15up_20 + age15up_21 + age15up_22 + age15up_23 + age15up_24)

#HH$num.15up
HH <- HH %>% mutate(num.15up.cat = case_when(
    num.15up %in% c(0, 1) ~ "0 to 1",
    num.15up %in% c(2) ~ "2",
    num.15up %in% c(3:4) ~ "3-4",
    num.15up >=5 ~ "5 and up"))
  
# Recode num.15up as binary
HH$num.15up.2plus<-ifelse(HH$num.15up>=2,1,0)
#table(HH$num.15up.4plus)
table(HH$num.15up)
```

### 2.2.2. Partner does not live in the household (among women married or in union)
```{r}
#v504: Whether the partner lives in the household or is now living elsewhere. BASE: Currently married or in union women (V502 = 1).
#v501: Current marital status of the respondent
#IR$v504 #1 == "living with her", 2 == "staying elsewhere"
#IR$v501 #1 == "married", 2 == "living with partner", 0 == "never in union", 3 == "widowed", 4 == "divorced", 5 == "no longer living together/separated"
IR <- IR %>% mutate(partner.absent = case_when(
  v504 == 1 ~ "No", 
  v504 == 2 ~ "Yes",
  !(v501 %in% c(1, 2)) ~ "Not in union"))

IR$partner.absent.yn <- ifelse(IR$partner.absent == "Yes", 1, 0)
#table(IR$partner.absent.yn)
```

### 2.2.3. Sex of head of household
```{r}
#v151: Sex of the head of the household; 1 == "male", 2 == "female"
IR$head.sex.male.num<-ifelse(IR$v151==1,1,0)
#class(IR$head.sex.male.num)
#table(IR$head.sex.male.num)
#sum(6350,43277)
```

### 2.2.4. Duration of marriage, among women still with first partner
```{r}
#v503:Whether the respondent has been married or lived with a man once or more than once. BASE: Ever-married women (V501 <> 0). 1 == "once", 2 == "more than once".
#v512: Years since start of first marriage or union (CMC)
IR$yrs.curr.pship <- ifelse(IR$v503 == 1 & IR$v501 %in% c(1, 2), IR$v512,
                              NA)
IR <- IR %>% mutate(pship.duration = case_when(
  v501 %in% c(0) ~ "Never in union",
  (v501 %in% c(3, 4, 5) | v503 %in% c(2)) ~ "No longer with first partner",
  yrs.curr.pship %in% c(0:4) ~ "Less than 5 years",
  yrs.curr.pship %in% c(5:39) ~ "More than 5 years"))
IR$pship.duration <- factor(IR$pship.duration, levels = c("Never in union", "Less than 5 years", "More than 5 years", "No longer with first partner"))
table(IR$pship.duration)
#sum(12701,5533,25671,5722) #49627
#5533/49627
#IR$v503
```

### 2.2.5. Number of living children (home, away from home)
```{r}
#v218: Total number of living children is the sum of variables V202 to V205. #sum(is.na(IR$v218)) #no NA
#table(IR$v218)
IR<-IR %>% mutate(num.child.alive.cat = case_when(
  v218 == 0 ~ "No kid",
  v218 %in% c(1:2) ~ "One to two kids",
  (v218 >= 3 & !is.na(v218)) ~ "Three or more kids")) %>% 
  mutate(num.child.alive.cat = factor(num.child.alive.cat, levels = c("No kid", "One to two kids", "Three or more kids")))
levels(IR$num.child.alive.cat)
table(IR$num.child.alive.cat)

IR$child.2plus <- ifelse(IR$v218 >=2 & !is.na(IR$v218), 1, 0)
table(IR$child.2plus)
#24870/49627

IR$child.3plus <- ifelse(IR$v218 >=3 & !is.na(IR$v218), 1, 0)
table(IR$child.3plus)
#12679/49627

IR$child.4plus <- ifelse(IR$v218 >=4 & !is.na(IR$v218), 1, 0)
#table(IR$child.4plus)
#sum(44171,5456)
#5456/49627

IR$num.children <- IR$v218
#table(IR$v218)
IR$num.children <- ifelse(IR$v218 >= 10, 10, IR$v218)
#table(IR$num.children)
IR$num.children <- as.factor(IR$num.children)
```

### 2.2.6. Number of living children by age (U5, U15)
```{r}
# Number under 5
BR <- BR %>%
  group_by(caseid) %>%
  mutate(kids.under5 = sum(b8 <5, na.rm = TRUE))
#table(BR$kids.under5)
#class(BR$kids.under5)
#sum(50483,29125,6098,546,13)
#sum(is.na(BR$kids.under5))

BR <- BR %>% mutate(kids.under5.cat = case_when(
    kids.under5 == 0 ~ "None",
    kids.under5 == 1 ~ "One kid",
    kids.under5 >= 2 ~ "Two or more"))
BR$kids.under5.3plus <- ifelse(BR$kids.under5 >=3, 1, 0)
#class(BR$kids.under5.3plus)
#table(BR$kids.under5.3plus) #level 1 size too small
BR$kids.under5.1plus <- ifelse(BR$kids.under5 >=1, 1, 0)
BR$kids.under5.2plus <- ifelse(BR$kids.under5 >=2, 1, 0)

# number under 15
BR <- BR %>% 
  dplyr::group_by(caseid) %>%
  dplyr::mutate(kids.under15 = sum(b8 <15, na.rm = TRUE))
#table(BR$kids.under15)

BR <- BR %>% mutate(kids.under15.cat = case_when(
  kids.under15 == 1 ~ "One kid",
  kids.under15 == 2 ~ "Two kids",
  kids.under15 == 3 ~ "Three kids",
  kids.under15 >= 4 ~ "Four and more",
  TRUE ~ "None"))
#class(BR$kids.under15.cat)
#sum(7326,11298,26592,13381,27668) #86265
```

### 2.2.7. Number of children died
```{r}
#v206: Total number of sons who have died
#v207: Total number of daughters who have died
IR$num.child.die <- IR$v206 + IR$v207
IR <- IR %>% mutate(num.child.die.cat = case_when(
    num.child.die %in% c(0) ~ "0",
    num.child.die %in% c(1) ~ "1",
    num.child.die >=2 ~ "2 or more"))
#table(IR$num.child.die.cat)
IR$num.child.die.yn <- ifelse(IR$num.child.die >=1, 1, 0)
#table(IR$num.child.die.yn)
#sum(is.na(IR$num.child.die.yn)) #no NA
```

### 2.2.8. Number of biological children living at home
```{r}
#v202: Total number of sons living at home; v203:Total number of daughters living at home
IR <- IR %>% 
  mutate(num.kids.house = v202 + v203, na.rm=TRUE)

IR <- IR %>% mutate(num.kids.house.cat = case_when(
  num.kids.house == 0 ~ "No child",
  num.kids.house == 1 ~ "One child",
  num.kids.house == 2 ~ "Two children",
  TRUE ~ "Three or more")) %>% 
  mutate(num.kids.house.cat = factor(num.kids.house.cat, levels = c("No child", "One child", "Two children","Three or more")))
#table(IR$num.kids.house.cat)
#sum(17352,11853,12116,8306)

IR$num.kids.house.2plus <- ifelse(IR$num.kids.house.cat=="Two children" | IR$num.kids.house.cat=="Three or more",1,0)
IR$num.kids.house.3plus <- ifelse(IR$num.kids.house.cat=="Three or more",1,0)
#class(IR$num.kids.house.2plus)
#table(IR$num.kids.house.3plus)

#table(IR$num.kids.house)
IR$num.kids.house <- ifelse(IR$num.kids.house >=9, 9, IR$num.kids.house)
IR$num.kids.house <- as.factor(IR$num.kids.house)
```

### 2.2.9. Number of children living at home by age (U5, U15)
```{r}
# Under 5
#v137: Number of children resident in the household and aged 5 and under
IR <- IR %>% mutate(num.under5.cat = case_when(
    v137 == 0 ~ "0",
    v137 == 1 ~ "1",
    v137 ==2 ~ "2",
    (v137 >=3 & !is.na(v137)) ~ "3+"))
IR$num.under5.2plus <- ifelse(IR$v137 >=2 & !is.na(IR$v137), 1, 0)

# Under 15
HH <- HH %>%
  mutate(age15up_01 = ifelse(is.na(age_01), 0, ifelse(age_01 < 15, 1, 0))) %>% 
  mutate(age15up_02 = ifelse(is.na(age_02), 0, ifelse(age_02 < 15, 1, 0))) %>% 
  mutate(age15up_03 = ifelse(is.na(age_03), 0, ifelse(age_03 < 15, 1, 0))) %>% 
  mutate(age15up_04 = ifelse(is.na(age_04), 0, ifelse(age_04 < 15, 1, 0))) %>%
  mutate(age15up_05 = ifelse(is.na(age_05), 0, ifelse(age_05 < 15, 1, 0))) %>%
  mutate(age15up_06 = ifelse(is.na(age_06), 0, ifelse(age_06 < 15, 1, 0))) %>%
  mutate(age15up_07 = ifelse(is.na(age_07), 0, ifelse(age_07 < 15, 1, 0))) %>%
  mutate(age15up_08 = ifelse(is.na(age_08), 0, ifelse(age_08 < 15, 1, 0))) %>%
  mutate(age15up_09 = ifelse(is.na(age_09), 0, ifelse(age_09 < 15, 1, 0))) %>%
  mutate(age15up_10 = ifelse(is.na(age_10), 0, ifelse(age_10 < 15, 1, 0))) %>%
  mutate(age15up_11 = ifelse(is.na(age_11), 0, ifelse(age_11 < 15, 1, 0))) %>%
  mutate(age15up_12 = ifelse(is.na(age_12), 0, ifelse(age_12 < 15, 1, 0))) %>%
  mutate(age15up_13 = ifelse(is.na(age_13), 0, ifelse(age_13 < 15, 1, 0))) %>%
  mutate(age15up_14 = ifelse(is.na(age_14), 0, ifelse(age_14 < 15, 1, 0))) %>%
  mutate(age15up_15 = ifelse(is.na(age_15), 0, ifelse(age_15 < 15, 1, 0))) %>%
  mutate(age15up_16 = ifelse(is.na(age_16), 0, ifelse(age_16 < 15, 1, 0))) %>%
  mutate(age15up_17 = ifelse(is.na(age_17), 0, ifelse(age_17 < 15, 1, 0))) %>%
  mutate(age15up_18 = ifelse(is.na(age_18), 0, ifelse(age_18 < 15, 1, 0))) %>%
  mutate(age15up_19 = ifelse(is.na(age_19), 0, ifelse(age_19 < 15, 1, 0))) %>%
  mutate(age15up_20 = ifelse(is.na(age_20), 0, ifelse(age_20 < 15, 1, 0))) %>%
  mutate(age15up_21 = ifelse(is.na(age_21), 0, ifelse(age_21 < 15, 1, 0))) %>%
  mutate(age15up_22 = ifelse(is.na(age_22), 0, ifelse(age_22 < 15, 1, 0))) %>%
  mutate(age15up_23 = ifelse(is.na(age_23), 0, ifelse(age_23 < 15, 1, 0))) %>%
  mutate(age15up_24 = ifelse(is.na(age_24), 0, ifelse(age_24 < 15, 1, 0)))

HH <- HH %>% 
  mutate(num.under15 = age15up_01 + age15up_02 + age15up_03 + age15up_04 + age15up_05 + age15up_06 + age15up_07 + age15up_08 + age15up_09 + age15up_10 + age15up_11 + age15up_12 + age15up_13 + age15up_14 + age15up_15 + age15up_16 + age15up_17 + age15up_18 + age15up_19 + age15up_20 + age15up_21 + age15up_22 + age15up_23 + age15up_24)

HH <- HH %>% mutate(num.under15.cat = case_when(
    num.under15 %in% c(0) ~ "0",
    num.under15 %in% c(1) ~ "1",
    num.under15 %in% c(2) ~ "2",
    num.under15 %in% c(3) ~ "3",
    num.under15 %in% c(4) ~ "4",
    num.under15 >=5 ~ "5 and up"))

HH <- HH %>% mutate(num.under15.cat1 = case_when(
    num.under15 %in% c(0) ~ "None",
    num.under15 %in% c(1:2) ~ "One to two",
    num.under15 %in% c(3) ~ "Three",
    num.under15 >=4 ~ "Four and more"))

HH <- HH %>% mutate(num.under15.cat2 = case_when(
    num.under15 %in% c(0) ~ "None",
    num.under15 %in% c(1:4) ~ "One to four",
    num.under15 >=5 ~ "Five and more"))
  
# Recode num.under15 as binary
HH$num.under15.2plus<-ifelse(HH$num.under15>=2,1,0)
HH$num.under15.3plus<-ifelse(HH$num.under15>=3,1,0)
#table(HH$num.under15.3plus) #42042  5921

# Ratio of kids under 5 to women 15-49
#hv010: Total number of eligible women indicates the number of women found eligible for the individual survey in the household schedule.
#hv014: Number of children resident in the household and aged 5 and under.
  HH$hh.kidwom.rat<-ifelse(HH$hv010 == 0, 0, (HH$hv014/HH$hv010))
  table(HH$hh.kidwom.rat)
  
HH <- HH %>% mutate(hh.kidwom.rat.cat = case_when(
  hh.kidwom.rat == 0 ~ "None",
  hh.kidwom.rat > 0 & hh.kidwom.rat <= 2.5 ~ "Less than 3",
  TRUE  ~ "Three or more"
))
  
  HH$hh.kidwom.rat.2plus<-ifelse(HH$hh.kidwom.rat>=2,1,0)
```

### 2.2.10. Number of children U15 living elsewhere
```{r}
#BR$b9 #0 == "respondent", 1 == "father", 2 == "other relative", 3 == "someone else", 4 == "lives elsewhere"
BR$lives.away <- ifelse((BR$b9 %in% c(4, 3, 2, 1) & BR$b8 <15), 1, 0)
 
BR <- BR %>% 
  group_by(caseid) %>%
  mutate(num.kids.away = sum(lives.away, na.rm = TRUE))
table(BR$num.kids.away)

BR <- BR %>% mutate(num.kids.away.cat = case_when(
  num.kids.away == 1 ~ "One kid",
  num.kids.away >=2 ~ "Two or more",
  TRUE ~ "None")) 
#BR$num.kids.away.cat
```

### 2.2.11. Partner's age and age difference
```{r}
#IR$v730, 96 == "96+", 98 == "don't know"
IR$partner.age <- as.numeric(IR$v730)
IR <- IR %>% mutate(partner.age.cat = case_when(
  v730 %in% c(15:19) ~ "15-19",
   v730 %in% c(20:24) ~ "20-24",
    v730 %in% c(25:29) ~ "25-29",
     v730 %in% c(30:34) ~ "30-34",
      v730 %in% c(35:39) ~ "35-39",
       v730 %in% c(40:44) ~ "40-44",
        v730 %in% c(45:49) ~ "45-49",
         v730 %in% c(50:54) ~ "50-54",
          v730 %in% c(55:59) ~ "55-59",
           v730 %in% c(60:64) ~ "60-64",
            v730 %in% c(65:69) ~ "65-69",
             v730 %in% c(70:96) ~ "70+",
  TRUE~ "Not in union"))
#table(IR$partner.age.cat) #Not in union (15278)

# Age difference
IR$age.diff <- IR$v730 - IR$v012
IR$age.diff[is.na(IR$v730) | IR$v730 > 96] <- NA

IR <- IR %>% mutate(age.diff.cat = case_when(
  age.diff < (-2) ~ "Partner 2 or more years younger",
  age.diff %in% c(-1:1) ~ "Partner within 1 year",
  age.diff %in% c(2:5) ~ "Partner 2-5 years older",
  age.diff %in% c(6:10) ~ "Partner 6-10 years older",
  age.diff >10 & !is.na(age.diff) ~ "Partner more than 10 years older",
  !(v501 %in% c(1, 2)) ~ "Not in union"))
IR$age.diff.cat <- factor(IR$age.diff.cat, levels = c("Partner 2 or more years younger",
  "Partner within 1 year", "Partner 2-5 years older", "Partner 6-10 years older", "Partner more than 10 years older",
  "Not in union"))
#table(IR$age.diff.cat)
#sum(15160,7176,1532,13305,8352,3163) 

IR <- IR %>% mutate(age.diff.cat.new = case_when(
  (age.diff < (-2) |age.diff %in% c(-1:1))  ~ "Minor diff or partner younger",
  !(v501 %in% c(1, 2)) ~ "Not in union",
  TRUE ~ "Partner somewhat older")) %>% 
  mutate(age.diff.cat.new = factor(age.diff.cat.new, levels = c("Minor diff or partner younger", "Partner somewhat older", "Not in union")))
#table(IR$age.diff.cat.new)
#levels(IR$age.diff.cat.new)
```

### 2.2.12. Partner's education
```{r}
#IR$v729, 0 == "no education", 1 == "incomplete primary", 2 =="complete primary", 3 == "incomplete secondary", 4 == "complete secondary", 5 == "higher"， 8 == "don't know"
#v502: Whether the respondent is currently, formerly or never married (or lived with a partner). 0 =="never in union", 1 =="currently in union/living with a man", 2 == "formerly in union/living with a man"
table(IR$v729)
IR$no.partner<-ifelse((IR$v502== 0| IR$v502==2),1,0)
IR <- IR %>% mutate(husb.ed.grp = case_when(v729 == 0 ~ "no education", v729 == 1 ~ "incomplete primary", v729 == 2 ~ "complete primary", v729 == 3 ~ "incomplete secondary", v729 == 4 ~ "complete secondary", v729 == 5 ~ "higher", v729 == 8 ~ "don't know", no.partner == 1 ~ "Not in union")) %>% 
  mutate(husb.ed.grp = as.factor(husb.ed.grp))

IR <- IR %>% mutate(husb.ed.mtprim = ifelse(husb.ed.grp %in% c("incomplete secondary", "complete secondary", "higher"), 1, 0))

IR$husb.ed.ever <- as.factor(IR$s903)
#table(IR$husb.ed.grp)
#table(IR$husb.ed.mtprim)
#table(IR$husb.ed.ever)

#IR$v715: Most recent husband or partner's education in single years.
IR$husb.ed.year <- as.numeric(IR$v715)
#table(IR$husb.ed.mtprim)
```

### 2.2.13. Woman had previous partnerships
```{r}
#v503: BASE: Ever-married women (V501 <> 0). 1 == "once", 2 == "more than once". v501: 0=="never in union"
IR <- IR %>% mutate(prev.pship = case_when(
  v503 %in% c(1) ~ "No",
  v503 %in% c(2) ~ "Yes",
  v501 %in% c(0) ~ "Never in union"))
table(IR$prev.pship)
```

### 2.2.14. Decision making
```{r}
# Financial decision-making

## Joint decision
### v739: from question 919: Who usually decides how the money you earn will be used: you, your (husband/partner), or you and your (husband/partner) jointly? 1 == "respondent alone", 2 == "respondent and husband/partner", 3 == "respondent and other person", 4 == "husband/partner alone", 5 == "someone else"
### v741:from question 916: Are you paid in cash or kind for this work or are you not paid at all? 0 =="not paid", 1 =="cash only", 2=="cash and in-kind", 3=="in-kind only"
### v731: from question 912: Have you done any work in the last 12 months? 0 =="no", 1 =="in the past year", 2 =="currently working", 3 =="have a job, but on leave last 7 days"
IR$jd.ownincome <- ifelse(IR$v739== 2,1,0)

IR <- IR %>% mutate(jd.ownincome.cat = case_when(
    v739 == 2 ~ "Yes",
    (!is.na(v739) & !(v739 == 2)) ~ "No",
    !(v501 %in% c(1, 2)) ~ "Not in union",
    (v501 %in% c(1, 2) & (v741 %in% c(0, 3) | v731 == 0)) ~ "Not paid in cash or not working"))
#sum(is.na(IR$jd.ownincome.cat))

## Own decision
IR$wd.ownincome <- ifelse(IR$v739== 1,1,0)

IR <- IR %>% mutate(wd.ownincome.cat = case_when(
    v739 == 1 ~ "Yes",
    (!is.na(v739) & !(v739 == 1)) ~ "No",
    !(v501 %in% c(1, 2)) ~ "Not in union",
    (v501 %in% c(1, 2) & (v741 %in% c(0, 3) | v731 == 0)) ~ "Not paid in cash or not working"))
#sum(is.na(IR$wd.ownincome.cat))  
##Joint or own decision
IR$jdwd.ownincome <- ifelse(IR$v739== 1 | IR$v739== 2,1,0)
# Large household purchases

## Joint decision
###v743b: from question 923: Who usually makes decisions about making major household purchases? 6 =="other"

IR$jd.lrgpur <- ifelse(IR$v743b== 2,1,0)

IR <- IR %>% mutate(jd.lrgpur.cat = case_when(
  v743b == 2 ~ "Yes",
  (!is.na(v743b) & !(v743b == 2)) ~ "No",
  !(v501 %in% c(1, 2)) ~ "Not in union"))
  
## Own decision
IR$wd.lrgpur <- ifelse(IR$v743b== 1,1,0)

IR <- IR %>% mutate(wd.lrgpur.cat = case_when(
  v743b == 1 ~ "Yes",
  (!is.na(v743b) & !(v743b == 1)) ~ "No",
  !(v501 %in% c(1, 2)) ~ "Not in union"))

##Joint or own decision
IR$jdwd.lrgpur <- ifelse(IR$v743b== 1 | IR$v743b==2,1,0)

# Husband's income
## Joint decision
###v743f: from question 921: Who usually decides how your (husband's/partner's) earnings will be used: you, your (husband/partner), or you and your (husband/partner) jointly? 7 == "husband/partner has no earnings"
IR$jd.money <- ifelse(IR$v743f== 2,1,0)

IR <- IR %>% mutate(jd.money.cat = case_when(
  v743f == 2 ~ "Yes",
  (!is.na(v743f) & !(v743f == 2)) ~ "No",
  !(v501 %in% c(1, 2)) ~ "Not in union"))
  
## Own decision
IR$wd.money <- ifelse(IR$v743f== 1,1,0)
#IR$v743f
IR <- IR %>% mutate(wd.money.cat = case_when(
  v743f == 1 ~ "Yes",
  (!is.na(v743f) & !(v743f == 1)) ~ "No",
  !(v501 %in% c(1, 2)) ~ "Not in union"))

##Joint or own decision
IR$jdwd.money <- ifelse(IR$v743f== 1 | IR$v743f==2,1,0)

# Health decision-making
## Joint decision
###v743a: Own health care, from question 922: Who usually makes decisions about health care for yourself: you, your (husband/partner), you and your (husband/partner) jointly, or someone else?
IR$jd.hlth <- ifelse(IR$v743a== 2,1,0)
IR <- IR %>% mutate(jd.hlth.cat = case_when(
    v743a == 2 ~ "Yes",
    (!is.na(v743a) & !(v743a == 2)) ~ "No",
    !(v501 %in% c(1, 2)) ~ "Not in union"))
  
## Own decision
IR$wd.hlth <- ifelse(IR$v743a== 1,1,0)
IR <- IR %>% mutate(wd.hlth.cat = case_when(
    v743a == 1 ~ "Yes",
    (!is.na(v743a) & !(v743a == 1)) ~ "No",
    !(v501 %in% c(1, 2)) ~ "Not in union"))
  
##Joint or own decision
IR$jdwd.hlth <- ifelse(IR$v743a== 1 | IR$v743a==2,1,0)

# Decisions about family planning (use is v632 or non-use is v632a)

## Joint decision
###v632: Women in union and using contraception are asked who decided on the use of contraception, from question 812. 1 == "mainly respondent", 2 =="mainly husband, partner", 3 == "joint decision", 6 == "other"
###v632a: Women in union, not using contraception and not pregnant are asked who decided on the non-use of contraception.
IR <- IR %>% mutate(jd.fp = case_when(
  (v632 %in% c(3) | v632a %in% c(3)) ~ "Yes",
   ((!is.na(v632) & !(v632 == 3)) | (!is.na(v632a) & !(v632a == 3))) ~ "No"))
IR$jd.fp <- ifelse(IR$jd.fp=='Yes',1,0)

IR <- IR %>% mutate(jd.fp.cat = case_when(
   (v632 %in% c(3) | v632a %in% c(3)) ~ "Yes",
   ((!is.na(v632) & !(v632 == 3)) | (!is.na(v632a) & !(v632a == 3))) ~ "No",
   !(v501 %in% c(1, 2)) ~ "Not in union",
   v213 == 1 ~ "Pregnant"))
#table(IR$jd.fp.cat)
 
## Own decision
IR <- IR %>% mutate(wd.fp = case_when(
   (v632 %in% c(1) | v632a %in% c(1)) ~ "Yes",((!is.na(v632) & !(v632 == 1)) | (!is.na(v632a) & !(v632a == 1))) ~ "No"))
 IR$wd.fp <- ifelse(IR$wd.fp=="Yes",1,0)
 
IR <- IR %>% mutate(wd.fp.cat = case_when(
   (v632 %in% c(1) | v632a %in% c(1)) ~ "Yes",
   ((!is.na(v632) & !(v632 == 1)) | (!is.na(v632a) & !(v632a == 1))) ~ "No",
   !(v501 %in% c(1, 2)) ~ "Not in union",
   v213 == 1 ~ "Pregnant"))

## Joint or own decision
IR <- IR %>% mutate(jdwd.fp = case_when(
  v632 %in% c(3) | v632a %in% c(3) | v632 %in% c(1) | v632a %in% c(1) ~ "Yes",
  v632 %in% c(2) | v632 %in% c(6) ~ "No",
   v632a %in% c(2) | v632a %in% c(6) ~ "No"))
IR$jdwd.fp <- ifelse(IR$jdwd.fp=='Yes',1,0)

# Visit to family or relatives
## Joint decision
IR$jd.visit <- ifelse(IR$v743d== 2,1,0)
IR <- IR %>% mutate(jd.visit.cat = case_when(
  v743d == 2 ~ "Yes",
  (!is.na(v743d) & !(v743d == 2)) ~ "No",
  !(v501 %in% c(1, 2)) ~ "Not in union"))
 
## Own decision
IR$wd.visit <- ifelse(IR$v743d== 1,1,0)
 IR <- IR %>% mutate(wd.visit.cat = case_when(
 v743d == 1 ~ "Yes",
  (!is.na(v743d) & !(v743d == 1)) ~ "No",
  !(v501 %in% c(1, 2)) ~ "Not in union"))

##Joint or own decision
IR$jdwd.visit <- ifelse(IR$v743d== 1 | IR$v743d==2,1,0)

# When child is seriously ill # this was excluded after the 1st round of exploratory, so will remove the codes here and from the index 
 #from question s648b and s648c. s648b: can you decide by yourself whether or not the child should be taken for medical treatment? 0=="no", 1=="yes", 2=="depends". s648c: Who makes the final decision on whether or not the child should be taken for medical treatment? 1=="respondent", 2=="husband", 3=="respondent and husband jointly", 4=="husband and someone else jointly", 5=="respondent and someone else jointly", 6=="someone else". Note that base here is different from that for questions above, which were asked to women with husband. Here not to mutate for "not in union" - otherwise it would cause error in script 5)
#table(IR$s648b) #1 (yes,25726), 2(no, 5362), 3(depends,1057)
## Joint decision

# Index of  decision-making 
## Joint decision
IR<-IR %>% 
  mutate(jd.sum = ifelse((!is.na(jd.hlth)) | (!is.na(jd.fp)) | (!is.na(jd.lrgpur)) | (!is.na(jd.visit)) | (!is.na(jd.money)) | (!is.na(jd.ownincome)), jd.hlth + jd.fp + jd.lrgpur + jd.visit + jd.money + jd.ownincome, NA)) 
IR$jd.index <- as.numeric(IR$jd.sum)

### binary version, 0 = less joint decision making. So larger here in theory means less vulnerable
IR$jd.index.4plus<-ifelse(IR$jd.index>=4,1,0)
IR$jd.index.4plus[!(IR$v501 %in% c(1, 2))] <- 0
#table(IR$jd.index.5plus)

### Categorical
IR <- IR %>% mutate(jd.index.cat = case_when(
     !(v501 %in% c(1, 2)) ~  "Not in union",
     jd.index %in% c(1:3) ~ "One to three",
     jd.index %in% c(4:6) ~ "Four to six",
     TRUE ~ "None",
   ))
#table(IR$jd.index.cat)

## Own decision
IR<-IR %>%
  mutate(wd.sum = ifelse((!is.na(wd.hlth)) | (!is.na(wd.fp)) | (!is.na(wd.lrgpur)) | (!is.na(wd.visit)) | (!is.na(wd.money)) | (!is.na(wd.ownincome)), wd.hlth + wd.fp + wd.lrgpur + wd.visit + wd.money + wd.ownincome, NA)) 
#IR$wd.sum
IR$wd.index <- as.numeric(IR$wd.sum)

### Binary version, 0 = women make no decisions
IR$wd.index.none <- ifelse(IR$wd.index == 0,1,0)
IR$wd.index.none[IR$marr.cohab==0] <- 0

#table(IR$v501)
#sum(12701,927,1363,169)  #15160 (same as IR$marr.cohab==0)

###Categorical
IR <- IR %>% mutate(wd.index.cat = case_when(
     !(v501 %in% c(1, 2)) ~  "Not in union",
     wd.index %in% c(1:3) ~ "One to three",
     wd.index %in% c(4:6) ~ "Four to six",
     TRUE ~ "None",
   ))

## Joint or own decision
IR<-IR %>%
  mutate(jdwd.sum = ifelse((!is.na(jdwd.hlth)) | (!is.na(jdwd.fp)) | (!is.na(jdwd.lrgpur)) | (!is.na(jdwd.visit)) | (!is.na(jdwd.money)) | (!is.na(jdwd.ownincome)), jdwd.hlth + jdwd.fp + jdwd.lrgpur + jdwd.visit + jdwd.money + jdwd.ownincome, NA)) 
 
IR$jdwd.index<-as.numeric(IR$jdwd.sum)

### Binary version, 1 = more decision making
IR$jdwd.index.4plus<-ifelse(IR$jdwd.index>=4,1,0)
IR$jdwd.index.4plus[IR$marr.cohab==0] <- 0

### Categorical
IR <- IR %>% mutate(jdwd.index.cat = case_when(
     !(v501 %in% c(1, 2)) ~  "Not in union",
     jdwd.index %in% c(1:3) ~ "One to three",
     jdwd.index %in% c(4:6) ~ "Four to six",
     TRUE ~ "None"
   ))

```

### 2.2.15. Ability to refuse sex or to ask to use a condom
```{r}
#from question s714A: Can you say 'no' to your husband/partner if you don't want to have sexual intercourse? question s714B: Can you ask your husband/partner to use condom? (yes/no/don't know). Cannot find the recoded variable name from the recode mannual, but checked the variable named after the question number (e.g. s714a, s714b, etc.), seems matched.
#IR$s714a
#summary(IR$s714a) #12428 NAs #for v501, "never in union" is 12701, more than the NAs here. Looks like some "never in union" ppl actually answered this question of 714. Group the remaining as "Not partnered" instead of NAs for the next step, incl. dk
#summary(IR$s714b) #12427 NAs
IR <- IR %>% mutate(refuse.sex = case_when(
  s714a == 1 ~ "Yes",
  s714a == 0 ~ "No",
  TRUE ~ "Not partnered"
))
#class(IR$refuse.sex) #(yes, 22349)

IR <- IR %>% mutate(ask.condom = case_when(
  s714b == 1 ~ "Yes",
  s714b == 0 ~ "No",
  TRUE ~ "Not partnered"
))
#table(IR$ask.condom)
```

### 2.2.16. Partner support
```{r}
# Talked to partner about HIV prevention
 # from question 1032b: Have you ever talked about ways to prevent getting the virus that causes HIV-AIDS with your husband/partner? (but cannot find this from the recode mannual, does it mean that I can just use the question number as the variable name?)
#IR$s1032b #0--"no", 1=="yes"
#summary(IR$s1032b) #22893
IR <- IR %>% mutate(talk.hiv = case_when(
  s1032b == 1 ~ "Yes",
  s1032b == 0 ~ "No",
  TRUE ~ "Not partnered"
))
#class(IR$talk.hiv)
#table(IR$talk.hiv)

# Talked to partner about family planning
 # from question s816a: Have you ever talked about ways to prevent getting the virus that causes HIV-AIDS with your husband/partner? (yes/no). s816ba: husband/partner
IR$talk.fp <- as.character(IR$s816ba)
#class(IR$talk.fp)
#sum(is.na(IR$s816ba))
```

### Empowerment index
```{r}
SWPR<-cbind(SWPR, computeSWPER(SWPR))
SWPR <- SWPR %>% 
  dplyr::select(c("caseid", "SWPER.SCORE.1", "SWPER.SCORE.2", "SWPER.SCORE.3", "SWPER.EMPOWERMENT.1", "SWPER.EMPOWERMENT.2", "SWPER.EMPOWERMENT.3"))
#dim(SWPR)
```

## 2.3. Household economics and living conditions
### 2.3.1. Work status
```{r}
 #v714: based = all women, whether worked in last 7 days (apart from own housework). 0=="no", 1=="yes". v714a: from question 911: have any job or business from which you were absent for leave, illness, vacation, maternity leave, etc. (v714==0). v731: Have you done any work in the last 12 months? 0=="no", 1=="in the past year", 2=="currently working", 3=="have a job, but on leave last 7 days". v732: whether seasonal; base: women who are currently working or who have worked in the past year (V731 = 1 or 2 or 3), from question 915. 1=="all year", 2=="seasonal", 3=="occasional". v704a: partner's work status (base: V502 = 1). 0=="didn't work last 12 months", 1=="worked last 7 days", 2=="worked last 12 months", 8=="don't know".
# Work status
IR <- IR %>% mutate(working = case_when(
   (v714 == 1 & (v714a != 1 | is.na(v714a))) ~ "Currently working",
   (v714a == 1) ~ "On leave/absent",
   (v731 == 0) ~ "No work in the past year",
   (v731 == 1) ~ "Worked in the past year"))
#table(IR$working) #524 on leave

IR <- IR %>% mutate(working.new = case_when(
   (v714 == 1 & (is.na(v714a))) ~ "Working incl. on leave",
   (v731 == 0) ~ "No work in the past year",
   (v731 == 1) ~ "Worked in the past year"))
#table(IR$working.new)
 
IR$working.yn<-ifelse(IR$working=="Currently working" | IR$working=="Worked in the past year" | IR$working=="On leave/absent",1,0)

IR$workingnow.yn<-ifelse(IR$working=="Currently working",1,0)

# Work seasonality
IR <- IR %>% mutate(work.seasonal = case_when(
   v731 == 0 ~ "No work in the past 12 months",
   v732 == 3 ~ "Occassional",
   v732 == 2 ~ "Seasonal",
   v732 == 1 ~ "All  year"))
 
# Partner working
IR <- IR %>% mutate(partner.working = case_when(
   v704a == 1 ~ "Worked last 7 days",
   v704a == 2 ~ "Worked last 12 months",
   TRUE ~ "Not working or no partner"))
#table(IR$partner.working)

#sum(490,64,15182)

IR$partner.working.yn <- ifelse(IR$partner.working %in% c("Worked last 7 days", "Worked last 12 months"), 1, 0)
#table(IR$partner.working)
 
IR$partner.workingnow.yn <- ifelse(IR$partner.working %in% c("Worked last 7 days"), 1, 0)

# Type of work (women)
 #v717: Standardized respondent's occupation groups.Base: all women. 0 == "not working", 1 == "professional/technical/managerial", 2 == "clerical", 3 == "sales", 4 == "agricultural worker", 5 == "industrial worker", 7 == "services", 96 == "other", 98 == "don't know"

IR <- IR %>% mutate(work.type = case_when(
  (v717 == 1 |v717 == 2) ~ "Professional",
  (v717 == 3 | v717 == 7) ~ "Service",
  v717 == 4 ~ "Agricultural",
  v717 == 5 ~ "Industrial",
  TRUE ~ "Not working")) %>% 
  mutate(work.type = factor(work.type, levels = c("Professional", "Service", "Agricultural","Industrial","Not working")))
#table(IR$work.type)

IR <- IR %>% mutate(work.type.new = case_when(
   work.type %in% c("Agricultural") ~ "Agricultural",
   work.type %in% c("Professional") ~ "Professional",
   work.type %in% c("Service", "Industrial") ~ "Other types",
   work.type %in% c("Not working") ~ "Not working"))
#table(IR$work.type.new)

IR <- IR %>% 
  mutate(work.type.prof = case_when(
    (v717 == 1 | v717 == 2) ~ "Professional",
    (v717 == 3 | v717 == 4 | v717 == 5 | v717 == 7) ~ "Non professional",
    TRUE ~ "Not working")) %>% 
  mutate(work.type.prof = factor(work.type.prof, 
                                 levels = c("Professional", "Non professional", "Not working")))
#table(IR$work.type.prof)
```

### 2.3.2. Assets 
```{r}
# Productive assets: (by definition animal-drawn cart shall be part of the productive agricultural asset but it does not provide good fit, so will exclude animal-drawn cart ) hh.land (this is land for agriculture), hh.animal. Use case_when so that the individual asset var will be numeric for creating the sum and then index; the original class haven-labelled may course some problem later.
HH <- HH %>% 
  mutate(hh.land = case_when(hv244 == 0 ~ 0, hv244 == 1 ~ 1),
         hh.animal = case_when(hv246 == 0 ~ 0, hv246 == 1 ~ 1)) %>%
  mutate(product.sum = if(all(is.na(c(hh.land, hh.animal)))) NA else hh.land + hh.animal, na.rm = TRUE)
#table(HH$product.sum) #21828 (0) 15551 (1) 10572 (2); same result if as.numeric each var and then sum up
 ## For index, keep the 3 levels (0, 1, 2), to see if diff b/t having 1 vs having 2
HH <- HH %>% mutate(product.index = as.numeric(product.sum))
#table(HH$product.index)

 ##hv245: from question 120: How many hectares of agricultural land do members of this household own? 950 == "95 or more", 998 == "unknown"
HH <- HH %>% mutate(hh.land.ha = case_when(
  hv244 %in% c(0, 998, 999) ~ "0",
  hv245 %in% c(1:5) ~ "1- 5 ha",
  hv245 %in% c(6:10) ~ "6- 10 ha",
  hv245 %in% c(10:950) ~ "More than 10 ha"))

# Non-productive, vehicles (e.g., bicycle, motorcycle, car)
HH <- HH %>% 
  mutate(hh.bike = case_when(hv210 == 0 ~ 0, hv210 == 1 ~ 1),
         hh.motor = case_when(hv211 == 0 ~ 0, hv211 == 1 ~ 1),
         hh.car = case_when(hv212 == 0 ~ 0, hv212 == 1 ~ 1)) %>%
  mutate(vehic.sum = if(all(is.na(c(hh.bike, hh.motor, hh.car)))) NA else hh.bike + hh.motor + hh.car, na.rm = TRUE)
#table(HH$vehic.sum) # 9221 21702 13773  3200
  ## For index, create 3 levels: 0, 1, 2 (having 2+ pieces)
HH <- HH %>% mutate(vehic.index = case_when(
  vehic.sum == 1 ~ 1,
  vehic.sum %in% c(2,3) ~ 2,
  TRUE ~ 0)) 
#table(HH$vehic.index) #NAs coded as level 0

# Non-productive, personal materials (e.g., watch, mobile phone, computer)
HH <- HH %>% 
  mutate(hh.phone = case_when(hv243a == 0 ~ 0, hv243a == 1 ~ 1),
         hh.watch = case_when(hv243b == 0 ~ 0, hv243b == 1 ~ 1),
         hh.computer = case_when(hv243e == 0 ~ 0, hv243e == 1 ~ 1)) %>%
  mutate(person.sum = if(all(is.na(c(hh.phone, hh.watch, hh.computer)))) NA else hh.phone + hh.watch + hh.computer, na.rm = TRUE)
#table(HH$person.sum) # 4479 18152 15472  9797 
  ## For index, create 3 levels: 0, 1, 2 (having 2+ pieces)
HH <- HH %>% mutate(person.index = case_when(
  person.sum == 1 ~ 1,
  person.sum %in% c(2,3) ~ 2,
  TRUE ~ 0)) 
#table(HH$person.index)
# Mobile phone, watch, animal-drawn cart, boat with a motor, computer

# Non-productive, house amenities (e.g. electricity, radio, TV, refrigerator, non-mobile telephone, fan, washing machine, air conditioner)
HH <- HH %>% 
  mutate(hh.electricity = case_when(hv206 == 0 ~ 0, hv206 == 1 ~ 1),
         hh.radio = case_when(hv207 == 0 ~ 0, hv207 == 1 ~ 1),
         hh.tv = case_when(hv208 == 0 ~ 0, hv208 == 1 ~ 1),
         hh.refrig = case_when(hv209 == 0 ~ 0, hv209 == 1 ~ 1),
         hh.tele = case_when(hv221 == 0 ~ 0, hv221 == 1 ~ 1),
         hh.fan = case_when(sh121g == 0 ~ 0, sh121g == 1 ~ 1),
         hh.wash = case_when(sh121h == 0 ~ 0, sh121h == 1 ~ 1),
         hh.air = case_when(sh121i == 0 ~ 0, sh121i == 1 ~ 1)) %>%
  mutate(house.sum = if(all(is.na(c(hh.electricity, hh.radio, hh.tv, hh.refrig, hh.tele, hh.fan, hh.wash, hh.air)))) NA else hh.electricity + hh.radio + hh.tv + hh.refrig + hh.tele + hh.fan + hh.wash + hh.air, na.rm = TRUE)
#table(HH$house.sum) #from 0 to 8
  ## For index, create 3 levels: [0:2] ~ 0, [3:5] ~ 1, [6:8] ~ 2
HH <- HH %>% mutate(house.index = case_when(
  house.sum %in% c(3,4,5) ~ 1,
  house.sum %in% c(6,7,8) ~ 2,
  TRUE ~ 0)) 
#table(HH$house.index)

#Number of livestock (0 =="none", 95 == "95 or more", 98 =="don't know"; they have animals (but don't know how many) if they said 98). All NAs for asset.cattle, asset.goats, asset.pig. After 1st round of exploratory, these vars are excluded.
 ##Milk cows or bulls
 ## Water buffaloe
 #HH <- HH %>% mutate(asset.buffaloe = case_when(hv246b %in% c(1:98) ~ 1, hv246b %in% c(0) ~ 0))
 ## Horses or donkey
 #HH <- HH %>% mutate(asset.horses = case_when(hv246c %in% c(1:98) ~ 1, hv246c %in% c(0) ~ 0))
 ## Chickens or other poultry
 #HH <- HH %>% mutate(asset.chickens = case_when(hv246f %in% c(1:98) ~ 1,hv246f %in% c(0) ~ 0))
    
 ## Number of types of livestock
 #HH <- HH %>% mutate(asset.livestock.types = if(all(is.na(c(asset.buffaloe,asset.horses,asset.chickens)))) NA else asset.buffaloe + asset.horses + asset.chickens)
```

### 2.3.3. House building materials
```{r}
#hv213: Main material of the floor. Country-specific code. 10 == "natural", 11 == "earth/sand", 12 == "dung"; 20 == "rudimentary", 21 == "wood planks", 22 == "palm/bamboo"; 30 == "finished", 31 == "parquet or polished wood", 32 == "vinyl or asphalt strips", 33 == "ceramic/marble/granite", 34 == "floor tiles/teraso", 35 == "cement/red bricks", 36 == "carpet"; 96 == "	other". #for the next steps purpose, group "96" into "rudimentary"
#table(HH$hv213)
HH <- HH %>% 
  mutate(hh.floor = case_when(
    hv213 %in% c(11, 12) ~ "natural",
    hv213 %in% c(21, 22, 96) ~ "rudimentary",
    hv213 %in% c(31, 32, 33, 34, 35, 36) ~ "finished"))
#table(HH$hh.floor)

#hv214: Main material of the walls. Country-specific code. 10=="natural", 12 =="cane/palm/trunks", 13=="dirt"; 20 =="rudimentary", 21=="bamboo with mud", 22=="stone with mud", 23=="uncovered adobe", 24=="plywood", 25=="cardboard", 26=="reused wood"; 30=="finished", 31=="woven bamboo",32=="stone with lime/cement",34=="cement blocks",35=="covered adobe",36=="wood planks/shingles",37=="plaster wire",38=="grc/gypsum/asbestos"; 96=="other" 
#table(HH$hv214)
HH <- HH %>% 
  mutate(hh.wall = case_when(
    hv214 %in% c(12, 13) ~ "natural",
    hv214 %in% c(21, 22, 23, 24, 25, 26, 96) ~ "rudimentary",
    hv214 %in% c(31, 32, 34, 35, 36, 37, 38) ~ "finished"))
#table(HH$hv214) #natural has a small sample sze

#hv215: Main material of the roof. Country-specific code. 10=="natural", 12=="thatch/palm leaf", 13=="sod"; 20=="rudimentary", 21=="rustic mat", 22=="palm/bamboo", 23=="wood planks"; 30=="finished", 31=="roofing", 32=="asbestos", 33=="tile", 34=="concrete", 35=="metal tile", 36=="roofing shingles"; 96=="other"
#table(HH$hv215)
HH <- HH %>% 
  mutate(hh.roof = case_when(
    hv215 %in% c(12, 13) ~ "natural",
    hv215 %in% c(21, 22, 23, 96) ~ "rudimentary",
    hv215 %in% c(31, 32, 33, 34, 35, 36) ~ "finished"))
#table(HH$hh.roof) #rudimentary has a very small smaple size (67), but shows quite diff from natural
#table(HH$hv215)
# Create an index
HH <- HH %>% 
  mutate(floor.index = case_when(hh.floor=="finished" ~ 2,hh.floor=="rudimentary" ~ 1,hh.floor=="natural" ~ 0),
         wall.index = case_when(hh.wall=="finished" ~ 2,hh.wall=="rudimentary" ~ 1,hh.wall=="natural" ~ 0),
         roof.index = case_when(hh.roof=="finished" ~ 2,hh.roof=="rudimentary" ~ 1,hh.roof=="natural" ~ 0)) %>% 
  mutate(material.sum = if(all(is.na(c(floor.index, wall.index, roof.index)))) NA else floor.index + wall.index + roof.index, na.rm = TRUE)
#table(HH$material.sum) #from 0 to 6. Consider index: [6] ~ 2: all 3 is finished; [3:5] ~ 1: at least 1 of the 3 is finished; [0:2]

HH <- HH %>% mutate(material.index = case_when(
  material.sum %in% c(6) ~ 2,
  material.sum %in% c(3:5) ~ 1,
  TRUE ~ 0))
#class(HH$material.index)
```

### 2.3.4. Housing condition and facility
```{r}
# Number of rooms for sleeping
 #hv216: Number of rooms used for sleeping in the household.
 #summary(HH$hv216) #39 NAs
HH <- HH %>% mutate(hh.rooms = case_when(
   hv216 >= 4 & !is.na(hv216) ~ "Four or more",
   hv216 %in% c(2,3) ~ "Two to three",
   TRUE ~ "One or fewer"))

HH$hh.rooms.2plus<-ifelse(HH$hv216=="2",0,1)
#table(HH$hh.rooms.2plus)
 
# Toilet (whether shared, type)
  #hv225: whether sharing it with other household, from question 110. 0=="no, 1=="yes" (but data collected is all NA)
  #hv205: type of toilet facility. 10=="flush toilet", 11 =="flush to piped sewer system", 12=="flush to septic tank", 13=="flush to pit latrine", 14=="flush to somewhere else", 15=="flush, don't know where", 16=="flush with no septic tank",17=="flush toilet : shared / public"; 20=="pit toilet latrine", 21=="ventilated improved pit latrine (vip)", 22=="pit latrine with slab", 23=="pit latrine without slab/open pit"; 30=="no facility", 31=="no facility/bush/field/river/ beach/ pond/pool", 41=="composting toilet", 42=="bucket toilet", 43=="hanging toilet/latrine", 96=="other" #for next step's ourpose, incl. 96 in "no facility"
  #table(HH$hv205) #no one chose 41, 42, or 43
HH <- HH %>%
  mutate(hh.toilet.type = case_when(
    hv205 %in% c(12, 13, 14, 15, 16, 17) ~ "flush toilet",
    hv205 %in% c(21, 22, 23) ~ "pit latrine",
    hv205 %in% c(31,96) ~ "no facility"))
#table(HH$hh.toilet.type)

HH <- HH %>% 
  mutate(hh.toilet.flush = case_when(hh.toilet.type %in% c("flush toilet") ~ "flush toilet",
                                     hh.toilet.type %in% c("pit latrine","no facility") ~ "no flush or no facility"))
#table(HH$hh.toilet.flush)

HH$latrine <- ifelse(HH$hv205 %in% c(20, 21, 23, 31, 41, 42, 43, 96), 1,0)
#class(HH$latrine)
HH$toilet.facility <-  ifelse(HH$hv205 %in% c(31, 30), 0,1)
table(HH$toilet.facility)

 #hv238:Number of households sharing toilet, from question 111. 95=="10 or more households", 98=="don't know". All households that share a toilet facility (HV225 = 1).
#summary(HH$hv238) #44124 NAs

HH <- HH %>% 
  mutate(hh.toilet.share = case_when(
    hv238 %in% (1:9) ~ "share with less than 10 households",
    hv238 %in% (10:95) ~ "share with 10 or more households",
    hv238 %in% (98) ~ "don't know",
    is.na(hv238) ~ "not sharing toilet"
  ))
#table(HH$hh.toilet.share)
```

### 2.3.5. Cooking related (COPD risk factors)
```{r}
#hv226: Type of cooking fuel, from question 113: What type of fuel does your household mainly use for cooking?. 1=="electricity", 2=="lpg", 3=="natural gas", 4=="biogas", 5=="kerosene", 6=="coal, lignite", 7=="charcoal", 8=="wood", 9=="straw/shrubs/grass", 10=="agricultural crop", 11=="animal dung", 95=="no food cooked in house", 96=="other".
#table(HH$hv226)
#hv241: from question 114: Is the cooking usually done in the house, in a separate building, or outdoors? 1=="in the house", 2=="in a separate building", 3=="outdoors", 6 =="other" (4 chose "other")
#hv242: from question 115: Do you have a separate room which is used as a kitchen? 0=="no", 1=="yes"
HH <- HH %>% mutate(hh.where.cook = case_when(
   hv226 == 95 ~ "No food cooked in house",
   hv241 == 3 ~ "Food cooked outdoors",
   hv241 == 2 ~ "Food cooked in a separate building",
   hv241 == 6 ~ "Other",
   hv241 == 1 & hv242 == 1 ~ "Food cooked inside in a separate kitchen",
   hv241 == 1 & hv242 == 0 ~ "Food cooked inside"))
#table(HH$hh.where.cook)
 
HH <- HH %>% mutate(hh.cook.inside = case_when(
   hh.where.cook %in% c("No food cooked in house", "Food cooked outdoors", "Other") ~ "No, elsewhere",
   hh.where.cook %in% c("Food cooked in a separate building") ~ "No, in a separate building",
   hh.where.cook %in% c("Food cooked inside in a separate kitchen", "Food cooked inside") ~ "Yes"))
#table(HH$hh.cook.inside) 
HH$hh.cook.inside.yn<-ifelse(HH$hh.cook.inside=="Yes",1,0)

HH <- HH %>% mutate(hh.cook.kitchen = case_when(
  hh.where.cook %in% c("Food cooked inside in a separate kitchen") ~ "Yes",
  TRUE ~ "No"))
#table(HH$hh.cook.kitchen)
```

### 2.3.6. Drinking water
```{r}
# Source of drinking water
 #hv201: from question 102: What is the main source of drinking water for members of your household? 10=="piped water"; 20 =="tube well water"; 30=="dug well (open/protected)"; 40=="surface from spring"; 51=="rainwater"; 61=="tanker truck", 62=="cart with small tank"; 71=="bottled water", 72=="refilled water"; 96=="other"
HH$hv201
HH$water <- ifelse(HH$hv201 %in% c(11, 12, 13, 14, 21, 31, 61,62,71,72), 0,1) #using the category from EH, but it does not include protected spring (41)

HH <- HH %>% mutate(water.cat = case_when(
  hv201 %in% c(11, 12, 13, 14, 21) ~ "Piped or borehole",
  hv201 %in% c(31, 41) ~ "Open protected",
  hv201 %in% c(61, 62, 71, 72) ~ "Tank or packed",
  TRUE ~ "Not protected"))
#table(HH$water.cat)
#sum(6305,12100,11566,17992)

# Treatment to make it safe
 #hv237: from question 107: Do you do anything to the water to make it safer to drink? 8 =="don't know"
 #hv237a - hv237f: from question 108: What do you usually do to make the water safer to drink? hv237x: other; hv237z: don't know
HH <- HH %>% mutate(hh.watpur.appr = case_when(
   hv237 %in% c(0,8) ~ 0,
   (hv237a == 1 | hv237b == 1 | hv237c == 1 | hv237d == 1 | hv237e == 1 | hv237f == 1) ~ 1,
   (hv237 == 1 & !(hv237a == 1 | hv237b == 1 | hv237c == 1 | hv237d == 1 | hv237e == 1 | hv237f == 1)) ~ 0))
#table(HH$hh.watpur.appr)

# Time to get water
 #hv204: from question 104: How long does it take to go there, get water, and come back? (in min) 996=="on premises", 998=="	don't know" 
#summary(HH$hv204) #62 NAs
HH <- HH %>% mutate(hh.wat.time = case_when(
   hv204 %in% c(0:10) ~ "0-10 mintues", 
   hv204 %in% c(11:30) ~ "11-30 minutes",
   hv204 %in% c(31:995) ~ ">30 minutes",
   hv204 %in% c(996) ~ "Water on premises"))

HH <- HH %>% mutate(hh.wat.time.11plus = case_when(
  hh.wat.time %in% c("0-10 mintues","Water on premises") ~ 0,
  hh.wat.time %in% c("11-30 minutes",">30 minutes") ~ 1))
#class(HH$hh.wat.time.11plus)

HH$hh.wat.time.yn<-ifelse(HH$hh.wat.time=="Water on premises",1,0)

# Water supply interruption (for piped water)
 #hv201a: Water not available for at least a day (in the past 2 weeks), from question 106: In the past two weeks, was the water from this source not available for at least one full day? 0=="no, not interrupted for a full day", 1=="yes, interrupted for a full day or more", 8=="don't know". 25305 NAs (this question was asked to hv201==11 or 12 or 13)
HH <- HH %>% mutate(hh.wat.interrupt = case_when(
  hv201a %in% c(0, 8) ~ "No / don't know", 
  hv201a %in% c(1) ~ "Yes",
  is.na(hv201a) & !is.na(hv201) ~ "Water from a source other than piped"))
#table(HH$hh.wat.interrupt)
```

### 2.3.7. Sanitation (handwashing)
```{r}
#hv230a: Observed place for handwashing, from question 139. 1=="observed, fixed place", 2=="observed, mobile place", 3=="not observed: not in dwelling", 4=="not observed: no permission to see", 5=="not observed: other reason"
#hv230b: Observed presence of water. 0=="water not available", 1== "water is available"
#hv232: Items present: Soap or detergent, from question 141A; hv232b:Items present: Ash, mud, sand, from question 141B
HH <- HH %>% mutate(hh.sanitation = case_when(
   (hv230b == 1 & hv232 == 1) ~ "Water and soap",
   (hv230b == 1 & hv232 == 0) ~ "Water no soap",
   (hv230b == 1 & hv232b == 1) ~ "Water and others",
   (hv230b == 1 & hv232b == 0) ~ "Water only",
   (hv230b == 0 & hv232 == 1) ~ "Soap no water",
   (hv230b == 0 & hv232b == 1) ~ "others no water",
   (hv230b == 0 & hv232 == 0) ~ "No water nor soap",
   (hv230b == 0 & hv232b == 0) ~ "No water nor others",
   hv230a %in% c(3, 4, 5) ~ "Washing place missing"))
#table(HH$hh.sanitation) #majority have water and soap  #"Water and others" has 0 obs.
   #hand washing station observed

HH <- HH %>% mutate(hh.sanitation.cat = case_when(
   hh.sanitation %in% c("Water and soap", "Water and others") ~ "Water and agents",
   hh.sanitation %in% c("Water no soap", "Water only") ~ "Water only",
   hh.sanitation %in% c("Soap no water", "others no water") ~ "Cleaning agents only",
   hh.sanitation %in% c("No water nor soap", "No water nor others", "Washing place missing") ~ "No facility"))
#table(HH$hh.sanitation.cat)

HH <- HH %>% mutate(hh.sanitation.cat1 = case_when(
  hh.sanitation.cat %in% c("Water and agents") ~ "full facility",
  hh.sanitation.cat %in% c("Water only","Cleaning agents only","No facility") ~ "Partial or no facility"))
#table(HH$hh.sanitation.cat1)

#HH$hh.sanitation.yn<-ifelse(HH$hh.sanitation=="Washing place not observed" | HH$hh.sanitation=="No water or soap observed" |HH$hh.sanitation =="No water or other cleansing agent observed",0,1) #this one was dropped after 1st round
```

### 2.3.8. Bank account ownership
```{r}
#for woman self: v170, 0=="no, 1=="yes"
IR$women.bank.acct <- as.character(IR$v170)
#class(IR$women.bank.acct)

#hv247: from question 123: Does any member of this household have a bank account or an account in a cooperative?
#table(HH$hv247)
HH$hh.bank.acct <- as.character(HH$hv247)
```

### 2.3.9. Wealth index
```{r}
# Wealth index
  #hv270: wealth index, a composite measure of a household's cumulative living standard. 1=="poorest", 2=="poorer", 3=="middle", 4=="richer", 5=="richest"
 #class(HH$hv270)
 #HH$hv271
  # Wealth index combined
  HH$wealth.index <- factor(HH$hv270)

  # Wealth index urban/rural
  HH$wealth.index.ur <- factor(HH$hv270a)

  # Binary urban/rural wealth index - 
  HH$wealth.index.poor<-ifelse(HH$wealth.index.ur==1,1,0)
  #table(HH$wealth.index.poor)
  
  # Ordinal urban/rural wealth index (1 is poorest)
  HH$wealth.index.ur.ord <- as.integer(HH$wealth.index.ur)
```

### 2.3.10. Migration
```{r}
#v104: Time lived in current place of residence, from question Q102: How long have you been living continuously in [xx]? (RECORD „00‟ YEARS if less than a year). 95=="always", 96=="visitor",97=="inconsistent",98=="don't know".
#table(IR$v104)
IR <- IR %>% 
  mutate(migrant = case_when(
    v104 %in% c(0,96) ~ "Less than 1 year",
    v104 %in% c(1:5) ~ "Less than 5 years",
    v104 %in% c(6:94) ~ "More than 5 years",
    v104 %in% c(95) ~ "Always live here"))
#class(IR$migrant)

IR$migrant.yn <- ifelse(IR$migrant == "Always live here", 0, 1)
```

## 2.4. Health mental models
### 2.4.1. Structural barriers to healthcare for herself
```{r}
 #v467:from question 1108: is each of the following a big problem or not a big problem:(1) v467b:Getting permission (2) v467c: Getting money needed for treatment (3) v467d: Distance, no nearby health facility (4) v467f: Not wanting to go alone. 0=="no problem", 1=="big problem", 2=="not a big problem". These 4 were what asked in Indonesia.
IR<- IR %>% mutate(med.permis = case_when(
  v467b ==2 | v467b == 0 ~ 0,
  v467b == 1 ~1))

IR<- IR %>% mutate(med.cost = case_when(
  v467c ==2 | v467c ==0 ~ 0,
  v467c == 1 ~1))

IR<- IR %>% mutate(med.distance = case_when(
  v467d ==2 | v467d ==0 ~ 0,
  v467d == 1 ~1))

IR<- IR %>% mutate(med.alone = case_when(
  v467f ==2 | v467f ==0 ~ 0,
  v467f == 1 ~1))

# index (mutated above so that 1 is a big problem, the rest is zero)
IR<-IR %>% 
  mutate(med.sum = med.permis + med.cost + med.distance + med.alone)
#table(IR$med.sum) #38 NAs #from 0 to 4

IR <- IR %>% 
  mutate(med.index = case_when(
    med.sum %in% c(0) ~ 0,
    med.sum %in% c(1) ~ 1,
    med.sum %in% c(2:4) ~ 2)) 
#table(IR$med.index)
# Binary indicator from index - larger is more problems
IR$med.index.2plus<-ifelse(IR$med.sum>=2,1,0)

IR$med.index.1plus<-ifelse(IR$med.sum>=1,1,0)
#table(IR$med.index.1plus)
```


### 2.4.2. Ability to conceive
```{r}
#625: a more liberal definition of infecundity, base = all women. 0 =="fecund", 1=="pregnant", 2=="postpartum amenorrheic", 3=="infecund, menopausal".
IR$infecund.meno <- ifelse(IR$v625 == 3, 1,
                            ifelse(!(is.na(IR$v625)), 0, NA))
```

### 2.4.3. Partner's perception on FP
```{r}
#from question s820A: Do you think that your husband/partner approves or disapproves of couples using a contraceptive method to avoid pregnancy?. 0=="disapprove", 1=="approve", 8=="dk".
#sum(is.na(IR$s820a))
IR <- IR %>% 
  mutate(partner.fp = case_when(
    (!v501 %in% c(1,2)) ~ "Not partnered",
    s820a == 1 ~ "Partner approves",
    s820a %in% c(0,8) ~ "Partner disapproves",
    TRUE ~ "Not applicable"))
#table(IR$partner.fp)
```

Perception on marriage (small size, unmarried 15-24, not to use now)
```{r}
# Perceived best age to get married: from question s1402: In your opinion, what is the best age for a woman to get married? 98==“don't know". If using UNICEF's definition to define early marriage (under the age of 18), there is not much difference
#summary(IR$s1402) #38946 NAs
IR <- IR %>% 
  mutate(age.best.marriage = case_when(
    s1402 > 0 & s1402 < median(s1402) ~ "Early age to marry",
    s1402 >= median(s1402) & s1402 <= 97 ~ "Not early age to marry",
    is.na(s1402) ~ NA,
    TRUE ~ "Don't know"
  ))
#table(IR$age.best.marriage)
```

Autonomy on choosing husband (small size, unmarried 15-24, not to use now)
```{r}
#from question s1406: Who is going to choose the person you will marry: your parents, yourself, or together ? 1=="self", 2=="parent",3=="relatives",4=="jointly"
#summary(IR$s1406) #38953 NAs
IR <- IR %>% 
  mutate(auto.marriage = case_when(
    s1406 == 1 | s1406 == 4 ~ "Full or partial autonomy",
    is.na(s1406) ~ NA,
    TRUE ~ "No control over"
  ))
```

Perceived autonomy on deciding number of children (small size, unmarried 15-24, not to use now)
```{r}
#From question s1409: Who do you think should decide on how many children a couple should have: the wife, the husband, the wife and husband or other people? 1=="wife", 3=="both" -> full or partial autonomy; 2=="husband",6=="others",8=="don't know" -> No control over
IR <- IR %>% 
  mutate(auto.child = case_when(
    s1409 == 1 | s1409 == 1 ~ "Full or partial autonomy",
    is.na(s1409) ~ NA,
    TRUE ~ "No control over"
  ))
table(IR$auto.child)
```

### 2.4.4. Male child preference
```{r}
#v627: ideal number of boys, v628: ideal number of girls; these come from question Q814: "How many of these children would you like to be boys, how many would you like to be girls and for how many would it not matter if it‟s a boy or a girl?" 96 == "other", 98 == "don't know". 13 NAs for v627, for v628

IR$child.pref.discrep <- ifelse(IR$v627 %in% c(0:30) & IR$v628 %in% c(0:30), IR$v627-IR$v628,
                                NA)
IR$male.child.pref <- ifelse(IR$child.pref.discrep > 0 & !is.na(IR$child.pref.discrep), 1,
                             ifelse(IR$child.pref.discrep <=0 & !is.na(IR$child.pref.discrep), 0,
                                                                      ifelse(IR$v627 %in% c(95:98) & IR$v628 %in% c(95:98), 0,
                                                                             NA)))
```

### 2.4.5. Informational barrier to FP
```{r}
#The survey question s815 asked women in the past 6 months if they have learned about FP from multiple sources. Source a, b, c are recoded, d, e, f (country-specific) are not recoded.
#table(IR$s815f) #31679 17918
#table(IR$v384d)
IR <- IR %>% 
  mutate(fp.info = case_when(
    (v384a == 1) & !(v384b==1 |v384c==1 |s815d==1 |s815e==1 |s815f==1) ~ "Radio only",
    (v384b == 1) & !(v384a==1 |v384c==1 |s815d==1 |s815e==1 |s815f==1) ~ "TV only",
    (v384c == 1) & !(v384a==1 |v384b==1 |s815d==1 |s815e==1 |s815f==1) ~ "Newspaper or magazine only",
    (s815d == 1) & !(v384b==1 |v384c==1 |v384a==1 |s815e==1 |s815f==1) ~ "Poster or pamphlet only",
    (s815e == 1) & !(v384b==1 |v384c==1 |v384a==1 |s815d==1 |s815f==1) ~ "Billboard or banner only",
    (s815f == 1) & !(v384b==1 |v384c==1 |v384a==1 |s815e==1 |s815d==1) ~ "Internet only",
    !(v384b==1 |v384c==1 |v384a==1 |s815e==1 |s815d==1 |s815f ==1) ~ "None of them",
    (is.na(v384a) & is.na(v384b) & is.na(v384c) & is.na(s815d) & is.na(s815e) & is.na(s815f)) ~ NA,
    TRUE ~ "Multiple sources"
  ))
#table(IR$fp.info)
IR$fp.info.yn <- ifelse(IR$fp.info == "None of them", 0,
                        ifelse(is.na(IR$fp.info), NA, 1))
#table(IR$fp.info.yn)
```

### 2.4.6. Autonomy on contraceptives
```{r}
#From survey question s819 (v632) (currently using contraceptives) and s820 (v632a) (currently not using) who decided so. 1=="mainly respondent", 2=="mainly husband, partner", 3=="joint decision", 6=="other". Here to create a binary, consider "mainly respondent" and "joint decision" to be "Full or partial autonomy".
#sum(is.na(IR$v632)) #28741 NAs
#sum(is.na(IR$v632a)) #38264 NAs
#sum(20886,11363) #32249
#table(IR$v632) #6867,1576,12386,57
#sum(29521, 2728)
#sum(4332, 922,5936,173)
#IR$v501
IR <- IR %>% 
  mutate(auto.contra = case_when(
    (v632 == 1 | v632a == 1 |v632 == 3 | v632a == 3) ~ "Full or partial autonomy",
    (v632 == 2 | v632a == 2 | v632 == 6 | v632a == 6) ~ "No control over",
   TRUE ~ "Not partnered"))
#table(IR$auto.contra) #29521, 2728, 17378
#sum(is.na(IR$auto.contra))

IR <- IR %>% 
  mutate(auto.contra.wd = case_when(
    (!v501 %in% c(1,2)) ~ "Not partnered",
    (v632 == 1 | v632a == 1) ~ "Women's decision mainly",
    (v632 == 2 | v632a == 2 | v632 == 6 | v632a == 6 | v632 == 3 | v632a == 3) ~ "Others' decision mainly",
  ))
#table(IR$auto.contra.wd)
```

## 2.5. Life in community and social support
### 2.5.1. Discussion on FP
```{r}
#from question s816a: In the last six months, have you discussed the practice of family planning with your friends, neighbors, or relatives? (yes/no), and question s816b (with whom: s816ba - s816bx). Create new categorical variable.
#table(IR$s816a) #21205 who received support
IR <- IR %>% 
  mutate(disc.fp = case_when(
    (s816ba == 1|s816bb == 1|s816bc==1|s816bd==1|s816be==1|s816bf==1|s816bg==1|s816bh==1) & !(s816bi==1) & !(s816bx==1) ~ "Family members only",
    (s816bi==1) & !(s816ba == 1|s816bb == 1|s816bc==1|s816bd==1|s816be==1|s816bf==1|s816bg==1|s816bh==1) & !(s816bx==1) ~ "Friends/neighbors only",
    (s816bx ==1) ~ "Someone else invovled",
    s816a == 0 ~ "Discuss with no one",
    (is.na(s816a)) ~ NA,
    TRUE ~ "Multiple support" 
  ))
#table(IR$disc.fp)
#sum(3555,9547,7066,1037) #21205 who received support

IR <- IR %>% mutate(disc.fp.yn = case_when(
   disc.fp %in% c("Family members only", "Friends/neighbors only", "Someone else invovled", "Multiple support") ~ 1,
   TRUE ~ 0))
#class(IR$disc.fp.yn)
```

Discussion on menstruation (small sample, unmarried 15-24, not used now)
```{r}
# Being approached by someone
 #from question s1306: Before you menstruated, did anyone talk to you about menstruation? 0=="no", 1=="yes". s1307: who talked to you about menstruated: s1307a - s1307a, s1307x.
#table(IR$s1306) #39007 NAs, 8281 who received support
IR <- IR %>% 
  mutate(disc.menst = case_when(
    (s1307b == 1 | s1307c == 1 | s1307d == 1 | s1307e == 1) & !(s1307a == 1 | s1307f == 1 | s1307g == 1 | s1307h == 1 | s1307x == 1) ~ "Family members only",
    (s1307a == 1) & !(s1307b == 1 | s1307c == 1 | s1307d == 1 | s1307e == 1 | s1307f == 1 | s1307g == 1 | s1307h == 1 | s1307x == 1) ~ "Friends only",
    (s1307f == 1) & !(s1307a == 1 | s1307b == 1 | s1307c == 1 | s1307d == 1 | s1307e == 1 | s1307g == 1 | s1307h == 1 | s1307x == 1) ~ "Teacher only",
    (s1307g == 1) & !(s1307a == 1 | s1307b == 1 | s1307c == 1 | s1307d == 1 | s1307e == 1 | s1307f == 1 | s1307h == 1 | s1307x == 1) ~ "Health service provider only",
    (s1307h == 1) & !(s1307a == 1 | s1307b == 1 | s1307c == 1 | s1307d == 1 | s1307e == 1 | s1307f == 1 | s1307g == 1 | s1307x == 1) ~ "Religious leader only",
    s1306 == 0 ~ "Discuss with no one",
    is.na(s1306) ~ NA,
    TRUE ~ "Multiple support" 
  ))
#table(IR$disc.menst)
#sum(1798,2081,7,4203,21,171) #8281 who received support

# Proactively approaching someone
 #from question s1308: The first time you menstruated, did you talk to anyone? s1308a - s1308a, s1308x; s1308z == "no one"
#summary(IR$s1308b) #39006 NAs
IR <- IR %>% 
  mutate(disc.menst.pro = case_when(
    (s1308b == 1 | s1308c == 1 | s1308d == 1 | s1308e == 1) & !(s1308a == 1 | s1308f == 1 | s1308g == 1 | s1308h == 1 | s1308x == 1) ~ "Family members only",
    (s1308a == 1) & !(s1308b == 1 | s1308c == 1 | s1308d == 1 | s1308e == 1 | s1308f == 1 | s1308g == 1 | s1308h == 1 | s1308x == 1) ~ "Friends only",
    (s1308f == 1) & !(s1308a == 1 | s1308b == 1 | s1308c == 1 | s1308d == 1 | s1308e == 1 | s1308g == 1 | s1308h == 1 | s1308x == 1) ~ "Teacher only",
    (s1308g == 1) & !(s1308a == 1 | s1308b == 1 | s1308c == 1 | s1308d == 1 | s1308e == 1 | s1308f == 1 | s1308h == 1 | s1308x == 1) ~ "Health service provider only",
    (s1308h == 1) & !(s1308a == 1 | s1308b == 1 | s1308c == 1 | s1308d == 1 | s1308e == 1 | s1308f == 1 | s1308g == 1 | s1308x == 1) ~ "Religious leader only",
    (s1306 == 0 | s1308z == 1)  ~ "Discuss with no one",
    is.na(s1308a) ~ NA,
    TRUE ~ "Multiple support" 
  ))
#table(IR$disc.menst.pro)
#sum(6624,538,2,2511,5) #9680 asked proactively
```

Discussion on sexual matters (small sample, unmarried 15-24, not used now)
```{r}
#s1501a - s1501h: from question 1501: I would like to know about the people with whom you have talked about or asked questions about reproductive health. Have you talked about these things with: s1501a - s1501h
IR <- IR %>% 
  mutate(disc.sex = case_when(
    (s1501b == 1 | s1501c == 1 | s1501d == 1 | s1501e == 1) & !(s1501a == 1 | s1501f == 1 | s1501g == 1 | s1501h == 1) ~ "Family members only",
    (s1501a == 1) & !(s1501b == 1 | s1501c == 1 | s1501d == 1 | s1501e == 1 | s1501f == 1 | s1501g == 1 | s1501h == 1) ~ "Friends only",
    (s1501f == 1) & !(s1501a == 1 | s1501b == 1 | s1501c == 1 | s1501d == 1 | s1501e == 1 | s1501g == 1 | s1501h == 1) ~ "Teacher only",
    (s1501g == 1) & !(s1501a == 1 | s1501b == 1 | s1501c == 1 | s1501d == 1 | s1501e == 1 | s1501f == 1 | s1501h == 1) ~ "Health service provider only",
    (s1501h == 1) & !(s1501a == 1 | s1501b == 1 | s1501c == 1 | s1501d == 1 | s1501e == 1 | s1501f == 1 | s1501g == 1) ~ "Religious leader only",
    !(s1501a == 1 | s1501b == 1 | s1501c == 1 | s1501d == 1 | s1501e == 1 | s1501f == 1 | s1501g == 1 | s1501h == 1)  ~ "No one",
    is.na(s1501a) & is.na(s1501b) & is.na(s1501c) & is.na(s1501d) & is.na(s1501e) & is.na(s1501f) & is.na(s1501g) & is.na(s1501h) ~ NA,
    TRUE ~ "Multiple support" 
  ))
#table(IR$disc.sex)
```

Preferred support for further sexual matters (small sample, unmarried 15-24, not used now)
```{r}
#s1502a - s1502h, s1502x, s1502z (don't know): from question 1502: If you want to know more about reproductive health, who would you like to ask? (health service provider and mother are top choices)
#table(IR$s1502z)
IR <- IR %>% 
  mutate(disc.sex.pro = case_when(
    (s1502b == 1 | s1502c == 1 | s1502d == 1 | s1502e == 1) & !(s1502a == 1 | s1502f == 1 | s1502g == 1 | s1502h == 1 |s1502i == 1  | s1502x == 1) ~ "Family members only",
    (s1502a == 1) & !(s1502b == 1 | s1502c == 1 | s1502d == 1 | s1502e == 1 | s1502f == 1 | s1502g == 1 | s1502h == 1 |s1502i == 1  | s1502x == 1) ~ "Friends only",
    (s1502f == 1) & !(s1502a == 1 | s1502b == 1 | s1502c == 1 | s1502d == 1 | s1502e == 1 | s1502g == 1 | s1502h == 1 |s1502i == 1 | s1502x == 1) ~ "Teacher only",
    (s1502g == 1) & !(s1502a == 1 | s1502b == 1 | s1502c == 1 | s1502d == 1 | s1502e == 1 | s1502f == 1 | s1502h == 1 |s1502i == 1 | s1502x == 1) ~ "Health service provider only",
    (s1502h == 1) & !(s1502a == 1 | s1502b == 1 | s1502c == 1 | s1502d == 1 | s1502e == 1 | s1502f == 1 | s1502g == 1 |s1502i == 1 | s1502x == 1) ~ "Religious leader only",
    (s1502i == 1) & !(s1502a == 1 | s1502b == 1 | s1502c == 1 | s1502d == 1 | s1502e == 1 | s1502f == 1 | s1502g == 1 |s1502h == 1 | s1502x == 1) ~ "Internet only",
    (s1502z == 1) & !(s1502a == 1 | s1502b == 1 | s1502c == 1 | s1502d == 1 | s1502e == 1 | s1502f == 1 | s1502g == 1 | s1502h == 1 | s1502x == 1) ~ "Don't know",
    is.na(s1502a) & is.na(s1502b) & is.na(s1502c) & is.na(s1502d) & is.na(s1502e) & is.na(s1502f) & is.na(s1502g) & is.na(s1502h) & is.na(s1502x) & is.na(s1502z) ~ NA,
    TRUE ~ "Multiple support" 
  ))
#table(IR$disc.sex.pro)
```

### 2.5.2. Health insurance
```{r}
#v481: from question 1109: Are you covered by any health insurance? base is all respondent, 0=="no", 1=="yes". In the survey question 1110, it asks for type a-e and x (other), allowing multiple choices.
#table(IR$v481) # no(19172), yes(30450)

# Coverage of health insurance
IR <- IR %>% 
  mutate(insurance.cov = case_when(
    (v481a == 1) & !(v481b == 1 | v481c == 1 | v481d == 1 | v481e == 1 | v481x == 1) ~ "Regional only",
    (v481b == 1) & !(v481a == 1 | v481c == 1 | v481d == 1 | v481e == 1 | v481x == 1) ~ "BPJS only",
    (v481c == 1) & !(v481a == 1 | v481b == 1 | v481d == 1 | v481e == 1 | v481x == 1) ~ "BPJS non-contri only",
    (v481d == 1) & !(v481a == 1 | v481b == 1 | v481c == 1 | v481e == 1 | v481x == 1) ~ "Private only",
    (v481e == 1) & !(v481a == 1 | v481b == 1 | v481c == 1 | v481d == 1 | v481x == 1) ~ "Employer's only",
    (v481 == 0) ~ "No insurance",
    (is.na(v481) ~ NA),
    TRUE ~ "Multiple coverage"
  ) )
#table(IR$insurance.cov)
#sum(1293,251,16087,732,10969,1118) #30450

IR <- IR %>% mutate(insurance.cov.cat = case_when(
   insurance.cov %in% c("Regional only") ~ "Regional only",
   insurance.cov %in% c("BPJS only", "BPJS non-contri only") ~ "BPJS only",
   insurance.cov %in% c("Private only") ~ "Private only",
   insurance.cov %in% c("Employer's only") ~ "Employer's only",
   insurance.cov %in% c("Multiple coverage") ~ "Multiple coverage",
   TRUE ~ "No insurance"))
#table(IR$insurance.cov.cat)

IR <- IR %>% mutate(insurance.cov.cat1 = case_when(
  insurance.cov.cat %in% c("Private only","Employer's only","Multiple coverage") ~ "EPM coverage",
  insurance.cov.cat %in% c("Regional only","BPJS only","No insurance") ~ "Other coverage"))
#class(IR$insurance.cov.cat1)

IR$insurance.cov.yn <- ifelse(IR$insurance.cov.cat == "No insurance", 0, 1)
#class(IR$insurance.cov.yn)
```

## 2.6. Larger Enviornment 
### 2.6.1. Place of residence
```{r}
HH<-HH %>% mutate(hh.urban = case_when(
   hv025==2 ~0,
   hv025== 1 ~1))
```

### 2.6.2. Urban slum
```{r}
# UN definition
HH$floor <- ifelse(HH$hv213 == 11 | HH$hv213== 12 | HH$hv213== 21 | HH$hv213== 22,1,0)
HH$wall <- ifelse(HH$hv214== 12 | HH$hv214== 13 | HH$hv214 == 21 | HH$hv214 == 22 | HH$hv214 == 23 | HH$hv214 == 25 | HH$hv214 == 26,1,0)

HH$members<-ifelse(HH$hv012 == 0, HH$hv013, HH$hv012)
HH$hh.rooms.num <- HH$hv216
HH$memsleep <- ifelse(HH$hh.rooms.num == 0,HH$members,HH$members/HH$hh.rooms.num)
HH$living <- ifelse(HH$memsleep > 3,1,0)
 
HH<-HH %>% 
   mutate(slum.sum = floor + water + latrine + living, na.rm=TRUE)

HH<-HH %>% mutate(slum1 = case_when(
   hv025==2 ~ "rural",
   (hv025 == 1 & slum.sum >= 2) ~ "urban slum",
   (hv025 == 1 & slum.sum < 2) ~ "urban non-slum"))

# Urban slum 2 - Zulu et al, 2002
HH$piped<- ifelse(HH$hv201 == 10 | HH$hv201== 11 | HH$hv201== 12 | HH$hv201== 14, 0,1)
HH$slum2 <- ifelse(HH$hh.urban == 1 & HH$hh.electricity == 0 & HH$latrine == 1 & HH$piped == 1, 1, 0)
```


#######################################
3. Create Segmentation Dataset
#######################################

## 3.1. Prepare
```{r}
#v005: Sample weight is an 8 digit variable with 6 implied decimal places. To use the sample weight divide it by 1000000 before applying the weighting factor.
HH$v001<-HH$hv001
HH$v002<-HH$hv002
IR$wt<-IR$v005/1000000
```

## 3.2. Select fewer variables as needed moving forward
```{r}
#tail(names(IR), 200) 
#double check the mutaed vairables, making sure they are included in IR.seg properly
IR.seg <- IR %>% 
  select(c("v001","v002","v005","v021","v023", "v024", "v201", "wt", "caseid", "age.yrs","ed.lev":"insurance.cov.yn"))
IR.seg <- IR.seg %>% 
  select(-c("dv.sum","no.partner", "wd.sum", "jd.sum", "med.sum", "age.best.marriage", "disc.menst", "disc.menst.pro", "age.1stbf", "auto.marriage", "auto.child","disc.sex", "disc.sex.pro"))
  # dropping some variables that were created as intermediaries or for 15-24 only
#dim(IR.seg) #49627 entries, 169 variables

#tail(names(HH), 150)
HH.seg <- HH %>% 
  dplyr::select(c("v001", "v002", "hv021", "hv023", "hv022", "hv023", "hv024", "hv025", "highestyearsedinHH.yrs", "highestyearsedinHH.7plus", "num.15up":"slum2"))
#dim(HH.seg) #47963 entries, 92 variables

#tail(names(BR), 50)
#BR.seg <- BR %>% dplyr::select(c("caseid", "lives.away":"kids.under15.cat")) #this is used because chunk 17 took unnormally long, and was firtst skipped to continue the rest; chunk 27 was run in the last thus the mutated cariables from chunk 27 came in the last here. If the softeware runs fast smoothly, likely gonna need the codes below. Anyway, double check the column names before selecting.
BR.seg <- BR %>% 
  dplyr::select(c("caseid", "kids.under5":"num.kids.away.cat"))
BR.seg <- BR.seg %>% 
  dplyr::select(-c("lives.away")) # dropping some variables that were created as intermediaries in construction of the target var
#dim(BR.seg) #86265 entries, 10 variables
BR.seg <- BR.seg %>% group_by(caseid) %>%
  filter(row_number() ==1)
#dim(BR.seg) #34199 entries, 10 variables
```

## 3.3. Check NAs before merging
```{r, eval=FALSE}
#install.packages("visdat")
#library(visdat)
#vis_dat(IR.seg[, 10:25])
#vis_dat(IR.seg[, 26:40])
#vis_dat(IR.seg[, 41:56])
#vis_dat(IR.seg[, 57:71])
#vis_dat(IR.seg[, 72:86])
#vis_dat(IR.seg[, 87:100])
#vis_dat(IR.seg[, 101:118])
#vis_dat(IR.seg[, 119:135])
#vis_dat(IR.seg[, 136:152])
#vis_dat(IR.seg[, 153:167])

#vis_dat(HH.seg[, 1:16])
#vis_dat(HH.seg[, 17:33])
#vis_dat(HH.seg[, 34:50])
#vis_dat(HH.seg[, 56:72])
#vis_dat(HH.seg[, 73:88])
```

## 3.4. Merge datasets
```{r}
vulnerability <-merge(IR.seg, HH.seg, by=c("v001", "v002"), all.x=T)
vulnerability <-merge(vulnerability, SWPR, by="caseid", all.x=T)
vulnerability <-merge(vulnerability, BR.seg, by="caseid", all.x=T)
#dim(vulnerability) #49627    274
#vulnerability$SWPER.SCORE.1
```

## 3.4. Set survey design matrix
```{r}
vulnerability.des <-svydesign(id=~v021, strata=~v023, weights=~wt, data=vulnerability)
```

## 3.5. Save merged datasets
```{r}
saveRDS(vulnerability, file = "4_Indonesia_DHS_vulnerability.rds")
saveRDS(vulnerability.des, file = "4_Indonesia_DHS_vulnerability_des.rds")
```


