


################################################################################
# IN-COUNTRY SEGMENT VULNERABILITY RANKINGS
################################################################################


###################################
# RUN SETUP
source("1_setup.R")

nreps = 20


###################################
# READ PATHWAYS WORKBOOOK
###################################

outcomes_vars_ranking <- readRDS(outcomes_excel_file) %>%
  dplyr::filter(ranking_include == 1) %>%
  dplyr::select(outcome_variable, short_name) %>%
  distinct()

if (nrow(outcomes_vars_ranking) == 0){
  stop("No variables selected for in-country ranking. Select variables in the Pathways Workbook.")
}


params_sheet <- readRDS(params_excel_file)

final_models <- params_sheet %>%
  dplyr::select(strata, final_model) %>%
  dplyr::filter(!is.na(strata))

strata_set <- unique(final_models$strata)


df <- data.frame()
for (stratum in strata_set){

  df_seg <- readRDS(paste0(lca_path, "nreps", nreps, "/", stratum, "_outcomes_vulnerability_class.rds"))

  final_model <- final_models %>%
    dplyr::filter(strata == stratum) %>%
    pull(final_model)

  df_seg$final_model <- df_seg[[final_model]]

  outcomes_vars <- names(df_seg)[names(df_seg) %in% outcomes_vars_ranking$outcome_variable]

  df_seg <- df_seg %>% dplyr::select(caseid, strata, final_model, wt, all_of(outcomes_vars)) %>%
    dplyr::mutate(final_model_strata = paste0(toupper(str_sub(strata, 1, 1)), final_model))

  df <- rbind(df, df_seg)

}


returns <- fun_gen_country_vulnerability_rankings(df=df, outcome_vars=outcome_vars, country_code="NN")

df_ranked <- bind_rows(returns[1])
box_plot <- returns[2]
print(box_plot)


###################################
# READ BACK IN OUTCOMES_VULNERABILITY_CLASS AND SAVE RANKED COLUMN

for (stratum in strata_set){

  df_ranked_merge <- df_ranked %>%
    dplyr::select(strata, final_model, segment_rank)

  df_seg <- readRDS(paste0(lca_path, "nreps", nreps, "/", stratum, "_outcomes_vulnerability_class.rds"))

  final_model <- final_models %>%
    dplyr::filter(strata == stratum) %>%
    pull(final_model)

  df_seg$final_model <- df_seg[[final_model]]


  df_seg <- df_seg %>%
    base::merge(df_ranked_merge, by=c("strata", "final_model"))

  saveRDS(df_seg, file = paste0(lca_path, "nreps", nreps, "/", stratum, "_outcomes_vulnerability_class_ranked.rds"))

}


###################################
print("7_country_vulnerability_ranking.R script complete! Proceed to run 8_quantitative_segment_profile.R script after updating Pathways Workbook. Refer to the README for instructions if needed.")







