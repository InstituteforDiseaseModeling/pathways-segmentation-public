


################################################################################
# GEN COUNTRY VULNERABILITY RANKINGS
################################################################################


###################################
# DEFINE FUNCTION
###################################

fun_gen_country_vulnerability_rankings <- function(df=NULL, outcome_vars=NULL, country_code=NULL){


  ###################################
  # HELPER FUNCTIONS

  remove_high_correlation <- function(cor_matrix, threshold = 0.9) {
    while(TRUE) {
      # Count the number of correlations above the threshold for each variable
      count_high_corr <- apply(abs(cor_matrix) > threshold, 2, sum) - 1  # subtract 1 to exclude self-correlation
      # Order the variables by this count
      var_order <- order(count_high_corr, decreasing = TRUE)
      var_to_remove <- colnames(cor_matrix)[var_order[1]]
      # Check if the maximum correlation is within the threshold
      max_cor <- max(abs(cor_matrix[lower.tri(cor_matrix)]))
      if (max_cor <= threshold) break
      # Remove the chosen variable from the correlation matrix
      var_index <- which(colnames(cor_matrix) == var_to_remove)
      cor_matrix <- cor_matrix[, -var_index]
      cor_matrix <- cor_matrix[-var_index, ]
    }
    return(colnames(cor_matrix))
  }


  # Min-max scaling function
  min_max_scale <- function(x) {
    (x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
  }


  ###################################
  #


  # keep binary columns and those that have a less than 30%  missing values
  binary_outcomes <- df %>%
    dplyr::select(where(~ all(.x %in% c(0, 1, NA)))) %>%
    names()

  df <- df %>%
    dplyr::select(caseid, strata, final_model, final_model_strata, wt, all_of(binary_outcomes))


  outcomes_vars <- df %>%
    dplyr::select(all_of(binary_outcomes)) %>%
    dplyr::select(where(~ mean(is.na(.x)) < 0.30)) %>%
    names()

  df <- df %>%
    dplyr::select(caseid, strata, final_model, final_model_strata, wt, all_of(outcomes_vars))


  # REMOVE HIGHLY CORRELATED VARIABLES
  df_corr <- df %>%
    dplyr::select(all_of(outcomes_vars))
  cor_matrix <- cor(df_corr, use = "complete.obs")
  remaining_vars <- remove_high_correlation(cor_matrix)


  df <- df %>%
    dplyr::select(caseid, strata, final_model, final_model_strata, wt, all_of(remaining_vars))


  df_melt <- df %>%
    reshape2::melt(id.vars=c("caseid", "wt", "strata", "final_model", "final_model_strata")) %>%
    dplyr::filter(!is.na(value)) %>%
    group_by(strata, final_model, final_model_strata, variable) %>%
    dplyr::summarize(percent_variable = sum(ifelse(value==1, wt, 0))/sum(wt))


  # DUNN'S TEST FOR PAIRWISE COMPARISON
  kruskal_result <- kruskal.test(percent_variable ~ final_model_strata, data = df_melt)
  print(kruskal_result)

  dunn_result <- dunn.test(x = df_melt$percent_variable,
                           g = df_melt$final_model_strata,
                           label = TRUE,
                           wrap = TRUE,
                           list = TRUE)

  classes <- unique(df_melt$final_model_strata)
  df_sig_vals <- data.frame(num_sig_diff = NA, final_model_strata = classes)

  for (i in 1:length(classes)){
    cls <- classes[i]
    idx <- grep(cls, dunn_result$comparisons)
    df_sig_vals$num_sig_diff[i] <- length(which(dunn_result$P[idx] <= .05))
  }

  df_melt_dunn <- df_melt %>%
    base::merge(df_sig_vals, by=c("final_model_strata"), all.x=TRUE)


  # CREATE BOX PLOT
  box_plot <- ggplot(df_melt_dunn, aes(x = final_model_strata, y = percent_variable, fill = num_sig_diff)) +
    geom_boxplot(outlier.shape = 19, outlier.size = 2, outlier.colour = "black") +
    scale_fill_gradient(low = "white", high = "red") +
    ylab("Normalized health outcomes 0 - best, 1 - worst") +
    xlab("Urban and Rural Segments") +
    coord_flip() +
    theme_minimal() +
    labs(fill = "Statistically\nSignificant\nPairwise\nDifferences",
         title = "Distribution of Normalized Health Outcomes by Segment")


  df_melt1 <- df_melt %>%
    group_by(variable) %>%
    dplyr::mutate(percent_variable_std = min_max_scale(percent_variable)) %>%
    group_by(strata, final_model, final_model_strata) %>%
    dplyr::summarize(med_std = median(percent_variable_std))

  df_ranked <- df_melt1 %>%
    dplyr::mutate(class_rank1 = case_when(med_std >= 0 & med_std <= 0.25 ~ 1,
                                          med_std > 0.25 & med_std <= 0.5 ~ 2,
                                          med_std > 0.5 & med_std <= 0.75 ~ 3,
                                          med_std > 0.75 & med_std <= 1 ~ 4)) %>%
    group_by(class_rank1) %>%
    arrange(med_std, .by_group = TRUE) %>%
    dplyr::mutate(class_rank2 = dense_rank(med_std) - 1,
                  segment_rank = paste0(str_sub(final_model_strata, 1, 1), class_rank1, ".", class_rank2, "-", country_code)) %>%
    ungroup() %>%
    arrange(strata, final_model) %>%
    dplyr::select(strata, final_model, final_model_strata, med_std, class_rank1, class_rank2, segment_rank)


  ###################################
  return(list(df_ranked, box_plot))

}
